<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>My thoughts about the Principal role</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="antonmry">
    <meta name="keywords" content="">
    <meta name="generator" content="generated-from-markdown">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">
  </head>
  <body>
    <div id="wrap">
      <div id="navbar-container"></div>
      <div class="container">
        <div id="content">
        <h1 id="my-thoughts-about-the-principal-role">My thoughts about the Principal role</h1>
        <p><em>05 May 2021</em></p>
        <p><img alt="Principal Software Engineer role" src="principal.jpg" title="Principal Software Engineer"></p>
        <h2 id="whats-a-principal-software-engineer">What's a Principal Software Engineer?</h2>
        <p>One of the things I couldn't answer in the last 4-5 years was my role.</p>
        <p><strong>Am I a manager? No.</strong> In some cases, people may report to me from an
        organisational point of view but my way to manage is "don't manage at all" and
        let the team self organize with my help. I tend to focus more on the team and
        processes and less on people. I'm not a manager, I try to be a technical leader.
        Organizations that understand the
        <a href="https://www.thekua.com/atwork/2019/02/the-trident-model-of-career-development/">Trident Career Model</a>
        have
        <em>"a great advantage because at scale, it is often hard to find people who have deep skills and experiences at both of these areas, and that it can be useful to discuss where someone's focus, passion or development progression lies"</em>.
        I think I could be a manager, but it wouldn't be so fun and, definitively, I
        don't want to be both things at the same time.</p>
        <p><strong>Am I a developer?</strong> Well, coding is something I like to do but I spent a lot
        more time helping others to code than coding myself. Even more important,
        because of frequent interruptions, I don't enjoy too much coding new features
        with hard deadlines. I prefer to work in proof of concepts or refactoring code
        because it isn't so problematic if I have to stop and resume it later. I also
        spend more time doing coding review than coding myself.</p>
        <p><strong>An architect?</strong> A big part of my work is to improve systems and platforms.
        Listen to problems and propose solutions. But I don't feel like the guy who does
        a plan which must be blindly followed by others. I don't want to be a gatekeeper
        who says what can be used and what can't.</p>
        <p>As Miguel Garcia pointed reviewing the article, not all architects are
        gatekeepers. But it may happen some times. I prefer the role of Principal
        because I see it as something less theoretical. It's hard to visualize a real
        architect building a house with their own hands. It isn't so hard to imagine a
        skilled workman designing and building a house. I see design and architecture as
        something more collaborative and myself as a facilitator. I usually share my
        experience doing similar things in the past and I help to make teams think out
        of the box or see their problems from a different perspective.
        <strong>I want teams working with me to find the right solution together</strong>.</p>
        <p>I also like to be involved in global architecture. As I see systems design as a
        collaborative task, global architecture works exactly in the same way but with
        other technical leaders and actors in the organization. When a C-level role
        defines the architecture without feedback from the technical leaders of the
        organization, it isn't only frustrating, it's also incomplete. Big organizations
        are too big to be designed by one individual (or a very small group): they need
        to be open and collaborative. See
        <a href="https://www.theatlantic.com/ideas/archive/2021/04/case-disagreeing-yourself/618688/">Before You Answer, Consider the Opposite Possibility</a>
        for more info.</p>
        <p><strong>Am I a product manager?</strong> I work a lot with the roadmap and backlog of the
        platforms where I'm more involved. Evangelize the usage of the service is very
        important. But this applies more to internal platforms. For public services,
        it's just too much work and someone focused only on that is required. As it's a
        bad idea to have the product manager taking decisions on the technical side
        (implementation), it isn't a good thing for the Principal to go too much in
        Product management: define the roadmap of the product, what works for the users,
        etc. PMs and principals should work together and respect their boundaries. When
        one of them push too much, the delivery slows down because of excess technical
        debt or over-engineering. Both things are wrong.</p>
        <p><strong>Staff Engineer?</strong> That's a tricky one because it's very dependant on the
        organization so I don't have an answer for that. In some places, the role is for
        seniors who jump between teams. In others, it's for engineers more focused on
        processes than in systems. Anyway, in my opinion, a Principal Software Engineer
        builds long term relations with systems and teams.</p>
        <p>The list goes on and on: Systems Engineer, Support Engineer, Project Manager,
        etc. Even the term "Individual contributor" seems wrong.
        <strong>My contributions aren't individual but working with individuals</strong>. The reality
        of the role is to do whatever is necessary to make teams and platforms succeed
        with the freedom to choose the best way to achieve it. A sort of technical "Jack
        of all trades, master of none".
        <a href="https://github.com/antonmry/galiglobal/pull/40#issuecomment-831733828">Martín Pérez comment</a>
        on this article explains it perfectly.</p>
        <p>One day I found this blog post in my timeline:
        <a href="https://margint.blog/2020/10/07/some-thoughts-on-the-principal-role/">Some Thoughts on the Principal Role</a>.
        Based on this article, it was clear to me:</p>
        <ul>
        <li>I prefer to <strong>help people</strong> instead of manage people.</li>
        <li>I like to be <strong>very involved in development</strong> but not necessarily code it
          myself, in special features which take more time and need more focus.</li>
        <li>I help with ideas, patterns and processes to <strong>build better systems</strong> but I
          don't like to tell other engineers what have to do.</li>
        </ul>
        <p>What a revelation! As explained in the article, I've been a Principal Software
        Engineer for years without being aware of it. Not only that,
        <strong>it's what I want to do, what makes me happy</strong> nowadays. It was great to know
        there is a name for my role and other people out there with the same motivations
        and struggles. It's for them, I wrote this article. I want to share my main
        challenges and experiences in this role.</p>
        <h2 id="no-clear-definition-of-the-role-the-management-trap">No clear definition of the role: the management trap</h2>
        <p>Many organizations don't understand the role. They understand they need it but
        not the role itself. This tends to lead to the "we need people with a strong
        technical background to lead our teams" approach.</p>
        <p>It's easier to fall into that trap. I think I'm joining the company as Principal
        but I end working as Project Manager (or similar). I have experience as an
        Engineering Manager but even with that, things don't evolve well in this
        situation. If I continue working as a manager, I will slowly lose my technical
        skills but the organization expects them so, in the long term, I won't meet
        their expectations. If I focus more on the technical part,
        <strong>I will neglect the people I manage</strong> which it's the most important job of a
        manager. If, somehow, I fight to keep both things
        <strong>I will end suffering job burnout</strong>. The article
        <a href="http://www.paulgraham.com/makersschedule.html">Maker's schedule, manager's schedule</a>
        is a great explanation about why both things aren't compatible in the long term.</p>
        <p>It isn't easy to solve this misalignment between the company and you. I usually
        try to <strong>make alliances with people managers</strong> so I can focus on my role as an
        engineer. I also evangelize about the role and how to implement it properly in
        the organization. Some of my tasks (recruiting, DevRel, community) require a lot
        of communication with HR and it helps to make them see the need for separated
        technical and people career paths.</p>
        <p>If after a while things don't evolve, a job change is the only alternative. Most
        organizations tend to listen when their engineers leave so it's a good
        opportunity to help them to make this right.</p>
        <h2 id="relation-with-managers">Relation with managers</h2>
        <p><strong>Build a good relation with engineering managers is very important</strong> to succeed
        in the role. It's quite frustrating when managers take decisions without taking
        engineers into account. It's especially problematic when they decide on
        technical things which have a huge impact on the platform. They should ask about
        architecture and processes. Principals should inform them to have the knowledge
        to report and publish to the rest of the organization what we are doing.</p>
        <p>This is particularly complex with managers who have a good technical background.
        Because they tend to try to manage people and systems. They are too busy so they
        take shortcuts: decide now, explain to the team later. It's hard to deal with
        this because it's an organisational issue.
        <strong>Managers should focus on people, engineers on systems. Processes should be the common ground.</strong></p>
        <p>Based in Eloy Coto's feedback, I'm going to stop here. Relation with managers is
        tricky and, in many cases, very dependant of the organization. If you have been
        working in big organization, you already know the relation with your manager is
        probably one of the main factors for success. I'm not particularly good on this
        so I need more advise than the advise I can give!</p>
        <h2 id="dont-be-a-hero">Don't be a hero</h2>
        <p>Another typical trap of the role is to become a hero. It may happen for many
        reasons, being typical that
        <strong>it's easier to ask you about something than to think about it</strong>. So other
        engineers may rely on you for tasks they don't like.</p>
        <p>This isn't an issue when starting with a team but it's a huge problem in the
        long term.
        <strong>If after one year, you can't leave a team without impact, you've failed in your work</strong>.
        It's that simple.</p>
        <p>One of the best ways to avoid this is to apply <strong>the leader-leader approach</strong> as
        explained in the book
        <a href="https://www.goodreads.com/book/show/16158601-turn-the-ship-around">Turn the ship around</a>.
        Don't tell people what they have to do but help them to define next the steps
        and identify trade-offs. I always try to make questions instead of giving
        answers: "Have you tried ...?", "What do you think of... ?", "What do you
        propose as an alternative?", etc.
        <a href="https://hyperbo.la/w/nemawashi/">Senior Engineers build consensus</a>. Mentorship
        is one of my main tasks.</p>
        <p>You will have a better life, and which it's more important, you will focus on
        what's important. Your teams will grow and learn and they will be happy because
        of that. <strong>Being a hero, you become the villain.</strong> Don't do that.</p>
        <h2 id="keep-your-optimism">Keep your optimism</h2>
        <p>Be a principal can be frustrating because your goals are now more aligned with
        your organization. It's a technical role but it's also oriented to people. You
        usually have a lot of meetings because of that, which it's probably one of the
        reasons you didn't become a manager in the first place.
        <strong>At some point, you may sense you aren't learning as much as you did in the past.</strong>
        That's a warning signal for me: things have to change.</p>
        <p><strong>Give you some space to experiment and do things that motivates you</strong> is
        essential to be successful in the long term. They may be not the most urgent
        things for the company but, in my experience, that's exactly why they are
        important.
        <strong>Principals should be able to see to the future and start that journey.</strong> If
        you are stuck all the time in what's urgent, it's very difficult to do that.
        Nacho Garmilla, another of my mentors, wrote in
        <a href="https://github.com/antonmry/galiglobal/pull/40#issuecomment-835821073">a comment</a>
        that the flexibility of the role can help on this: you don't have to limit
        yourself to your usual tasks: you can contribute in other areas if it's
        something motivating.</p>
        <p>There is an excellent article about this: <a href="https://noidea.dog/glue">Being glue</a>.
        It's from the perspective of a junior software engineer who wants to be promoted
        but it isn't because it's doing what's best for the team always. It ends badly.
        So, instead, try to save some time to do whatever makes you happy in your work.
        <strong>Ask for help.</strong> In the end, you will discover it has also value when properly
        combined with Glue work.</p>
        <p>Finally, if you encounter toxic people,
        <strong>don't let them make you lose your optimism.</strong> In most cases, report it to my
        manager and ignore them after that worked well for me.
        <strong>There are a lot of wonderful people out there</strong>: focus on them!.</p>
        <h2 id="dont-stop-coding">Don't stop coding</h2>
        <p>Coding is the best expression of the work of a Software Engineer.
        <strong>It's how we transform ideas into something real</strong>. It's also a very demanding
        task. If you stop coding for a while, you lose a lot of fluency and it becomes
        very frustrating. If you add the lack of enough long calendar slots and all the
        interruptions, it can be a nightmare. It's important for a Principal to feel
        confident when coding even if it isn't her primary task but it isn't easy to
        achieve it.</p>
        <p>Some tricks that help me with this:</p>
        <ul>
        <li>Try to <strong>block in your calendar some time every day for coding</strong>: I usually
          use my early mornings. Most of the team isn't connected yet and I'm fresh.
          Start the day with a Pull Request is a great feeling.</li>
        <li><strong>Avoid working on things that are on the critical path</strong>: you aren't going to
          have time. You think you will, but you don't. Deadline will arrive and the
          whole process will become very frustrating: deliver late or working
          after-hours. Both options are bad in the long term. So be realistic, don't
          work on critical features. I prefer to work in Technical Debt, refactorings or
          Proofs of Concept. There is a lot of value there because the team don't always
          have time to address these things and I can work without pressure.</li>
        <li><strong>Daily goal: code every day</strong>. I track my daily tasks and I have one for
          coding and another one for writing/reading. It isn't always possible but at
          least I have it very present.</li>
        <li><strong>Find something fun</strong>: pet projects are a good way to stay motivated and
          learn. They also require some time and that's very personal. Don't get
          frustrated if you don't have time for them, but if you do and you have fun, go
          for it.</li>
        <li><strong>Coding platforms</strong> are a great way to keep your skills. I recommend
          <a href="https://exercism.io/">exercism.io</a>. It's open and the exercise can be done in
          your favourite IDE. The feeling is quite close to a real problem.</li>
        </ul>
        <h2 id="career-goals">Career goals</h2>
        <p><strong>One of the problems in the role is what's come next</strong>. The principal role is
        at the end of the Individual Contributor path. Indeed, your contributions come
        now from the group you are helping. Yes, you can aspire to add Senior or
        whatever level number has your company... but that's just naming, which usually
        implies better a salary.
        <strong>Nobody complains about a salary raise but optimize to career based on the salary is a quite bad idea if you are already covered</strong>.</p>
        <p>You can aspire to a Distinguished / Fellow role. It's a legit goal. I'm not very
        familiar with these roles. In my head, they mean more salary and more contact
        with the C-Suite. Both things are fine but they aren't intrinsic motivations (at
        least not for me).</p>
        <p>There is always the option to move to the Management track as Senior Engineer
        Manager or Director. That's fine if it's what you want to do but it's just a
        different role and you should be aware of that.
        <strong>It has little value as a promotion if it isn't what makes your life happier</strong>.</p>
        <p>In summary, as Principal Software Engineer, promotions aren't going to be the
        goal so you need to find new ones and that's highly dependant on each person. In
        my case, it's to learn new things. It has been always my passion and the reason
        I'm a software engineer.
        <strong>This role allows me to learn new things every day and help others.</strong> I can't
        ask for anything more.</p>
        <h2 id="conclusions">Conclusions</h2>
        <p>I didn't cover everything I would like but this is article is already too long
        and I don't want to write a book (there is already one:
        <a href="https://www.goodreads.com/book/show/56481725-staff-engineer">Staff Engineer: Leadership beyond the management track</a>).
        I would love to know what do you think about the Principal role, especially if
        you disagree with me. Leave a comment on
        <a href="https://github.com/antonmry/galiglobal/pull/40">GitHub</a> or just drop me a
        message on <a href="https://bsky.app/profile/galiglobal.com">BlueSky</a>, I'm always open
        to have a chat about the role or share my experiences.</p>
        <h2 id="update">Update</h2>
        <p>This article made it to the top 5 articles in HackerNews! There are
        <a href="https://news.ycombinator.com/item?id=27231521">a lot of interesting comments</a>
        covering very different points of view.</p>
        </div>
        <div id="leaflet-comments" class="mt-4"></div>
      </div>
      <div id="push"></div>
    </div>

    <div id="footer-container"></div>

    <script src="/js/jquery-1.11.1.min.js"></script>
    <script src="/js/bootstrap.min.js" defer></script>
    <script src="/js/prettify.js" defer></script>

    <script>
      async function loadContent(url, elementId) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const html = await response.text();
          const target = document.getElementById(elementId);
          if (!target) return;
          target.innerHTML = html;

          const scripts = target.querySelectorAll('script[data-execute="true"]');
          scripts.forEach((oldScript) => {
            const newScript = document.createElement('script');
            [...oldScript.attributes].forEach((attr) => newScript.setAttribute(attr.name, attr.value));
            newScript.textContent = oldScript.textContent;
            target.appendChild(newScript);
          });
        } catch (error) {
          console.error(`Error loading ${url}:`, error);
          // Fallback to embedded versions if available
          if (elementId === 'navbar-container' && `<!-- Fixed navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="/index.html">About</a></li>
                <li><a href="/blog-posts.html">Blog</a></li>
                <li><a href="/public-talks.html">Talks</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="https://bsky.app/profile/anton.galiglobal.com" aria-label="BlueSky"><i class="fa-brands fa-bluesky social-icon"></i></a></li>
                <li><a href="https://www.linkedin.com/in/antonmry/" aria-label="LinkedIn"><i class="fab fa-linkedin social-icon"></i></a></li>
                <li><a href="https://github.com/antonmry" aria-label="GitHub"><i class="fab fa-github-square social-icon"></i></a></li>
                <li><a href="https://blog.anton.galiglobal.com/rss" aria-label="RSS"><i class="fas fa-rss-square social-icon"></i></a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</div>
`) {
            const target = document.getElementById(elementId);
            if (target) target.innerHTML = `<!-- Fixed navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="/index.html">About</a></li>
                <li><a href="/blog-posts.html">Blog</a></li>
                <li><a href="/public-talks.html">Talks</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="https://bsky.app/profile/anton.galiglobal.com" aria-label="BlueSky"><i class="fa-brands fa-bluesky social-icon"></i></a></li>
                <li><a href="https://www.linkedin.com/in/antonmry/" aria-label="LinkedIn"><i class="fab fa-linkedin social-icon"></i></a></li>
                <li><a href="https://github.com/antonmry" aria-label="GitHub"><i class="fab fa-github-square social-icon"></i></a></li>
                <li><a href="https://blog.anton.galiglobal.com/rss" aria-label="RSS"><i class="fas fa-rss-square social-icon"></i></a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</div>
`;
          }
          if (elementId === 'footer-container' && `<!-- start footer -->
<div id="footer">
  <div class="container">
    <p class="muted credit"><span class="small"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"/></a>&nbsp;&nbsp;This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</span></p>
  </div>
</div>
<!-- end footer -->

<!-- start scripts -->
<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="/js/jquery-1.11.1.min.js"><\/script>
<script src="/js/bootstrap.min.js"><\/script>
<script src="/js/prettify.js"><\/script>

<script>if (location.hostname === "localhost" || location.hostname === "127.0.0.1")
    document.write('<script src="http://'
    + (location.host || 'localhost').split(':')[0]
    + ':35729/livereload.js"></'
    + 'script>')<\/script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57796882-1', 'auto');
  ga('send', 'pageview');
<\/script>

<script data-execute="true">
  (function initLeafletComments() {
    const container = document.getElementById('leaflet-comments');
    if (!container) return;

    const statusId = 'leaflet-comments-status';
    const pathKey = location.pathname.replace(/^\\/+/, '');

    container.innerHTML = \`
      <hr class="text-muted" />
      <h3>Comments</h3>
      <p class="text-muted">Comments are mirrored from <a href="#" target="_blank" rel="noopener">Leaflet ↗</a>.</p>
      <p id="${statusId}">Loading comments...</p>
    \`;

    fetch('/leaflet-comments-map.json')
      .then((res) => {
        if (!res.ok) throw new Error('Map not found');
        return res.json();
      })
      .then(async (map) => {
        const mapping = map[pathKey] || map[\`/${pathKey}\`];
        if (!mapping) {
          setStatus('Comments not configured for this page.');
          return;
        }

        const leafLetUrl = typeof mapping === 'string' ? mapping : mapping.leafLetUrl;
        if (!leafLetUrl) {
          setStatus('Comments not configured for this page.');
          return;
        }

        const rkey = getRkeyFromUrl(leafLetUrl);
        if (!rkey) {
          setStatus('Could not determine comment thread.');
          return;
        }

        const did = 'did:plc:aldvhiaxmrkbewll3abu3roz';
        const collection = 'pub.leaflet.document';
        const atUri = \`at://${did}/${collection}/${rkey}\`;

        container.querySelector('.text-muted a')?.setAttribute('href', leafLetUrl);
        const records = [];
        let cursor = null;

        do {
          const res = await fetch(
            \`https://constellation.microcosm.blue/xrpc/blue.microcosm.links.getBacklinks?subject=${encodeURIComponent(
              atUri
            )}&source=pub.leaflet.comment:subject&limit=100${cursor ? \`&cursor=${cursor}\` : ''}\`
          );
          if (!res.ok) throw new Error(\`Backlinks request failed: ${res.status}\`);
          const data = await res.json();
          records.push(...(data.records || []));
          cursor = data.cursor;
        } while (cursor);

        if (!records.length) {
          setStatus('No comments yet.');
          return;
        }

        const comments = [];
        for (const record of records) {
          const recordUrl =
            \`https://slingshot.microcosm.blue/xrpc/com.atproto.repo.getRecord?\` +
            \`rkey=${encodeURIComponent(record.rkey)}&collection=${encodeURIComponent(
              record.collection
            )}&repo=${encodeURIComponent(record.did)}\`;

          const recordRes = await fetch(recordUrl, { headers: { Accept: 'application/json' } });
          if (!recordRes.ok) continue;
          const recordData = await recordRes.json();
          const value = recordData.value || {};

          // Resolve handle
          let handle = record.did;
          try {
            const handleRes = await fetch(
              \`https://slingshot.microcosm.blue/xrpc/com.bad-example.identity.resolveMiniDoc?identifier=${encodeURIComponent(
                record.did
              )}\`
            );
            if (handleRes.ok) {
              const handleData = await handleRes.json();
              if (handleData.handle) handle = handleData.handle;
            }
          } catch (err) {
            console.warn('Handle lookup failed', err);
          }

          comments.push({
            handle,
            createdAt: value.createdAt,
            text: value.plaintext || '',
            attachment: Boolean(value.attachment),
          });
        }

        clearStatus();
        renderComments(container, comments, leafLetUrl);
      })
      .catch((err) => {
        console.error('Failed to load Leaflet comments', err);
        setStatus('Could not load comments right now.');
      });

    function renderComments(containerEl, comments, leafLetUrl) {
      const list = document.createElement('div');
      list.className = 'leaflet-comments-list';

      comments
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
        .forEach((comment) => {
          const item = document.createElement('div');
          item.className = 'leaflet-comment mb-3';

          const header = document.createElement('div');
          header.className = 'd-flex justify-content-between';
          header.innerHTML = \`<strong>${escapeHtml(comment.handle)}</strong><span class="text-muted" style="margin-left:8px;">${relativeTime(
            comment.createdAt
          )}</span>\`;
          item.appendChild(header);

          if (comment.attachment) {
            const attachment = document.createElement('div');
            attachment.className = 'alert alert-info mt-2 mb-2';
            attachment.innerHTML = \`Quoted content. View on <a href="${leafLetUrl}" target="_blank" rel="noopener">leaflet.pub ↗</a>\`;
            item.appendChild(attachment);
          }

          const body = document.createElement('p');
          body.textContent = comment.text;
          item.appendChild(body);

          list.appendChild(item);
        });

      containerEl.appendChild(list);
    }

    function relativeTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = date - now;
      const diffSec = Math.round(diffMs / 1000);
      const intervals = [
        ['year', 60 * 60 * 24 * 365],
        ['month', 60 * 60 * 24 * 30],
        ['day', 60 * 60 * 24],
        ['hour', 60 * 60],
        ['minute', 60],
        ['second', 1],
      ];

      for (const [unit, secondsInUnit] of intervals) {
        const count = Math.trunc(diffSec / secondsInUnit);
        if (Math.abs(count) >= 1) {
          return new Intl.RelativeTimeFormat(undefined, { numeric: 'auto' }).format(count, unit);
        }
      }
      return 'just now';
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function setStatus(text) {
      const el = document.getElementById(statusId);
      if (el) el.textContent = text;
    }

    function clearStatus() {
      const el = document.getElementById(statusId);
      if (el) el.remove();
    }

    function getRkeyFromUrl(url) {
      try {
        const path = new URL(url).pathname;
        const parts = path.split('/').filter(Boolean);
        return parts[parts.length - 1] || null;
      } catch (e) {
        console.error('Invalid Leaflet URL', e);
        return null;
      }
    }
  })();
<\/script>
<!-- end scripts -->
`) {
            const target = document.getElementById(elementId);
            if (target) target.innerHTML = `<!-- start footer -->
<div id="footer">
  <div class="container">
    <p class="muted credit"><span class="small"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"/></a>&nbsp;&nbsp;This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</span></p>
  </div>
</div>
<!-- end footer -->

<!-- start scripts -->
<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="/js/jquery-1.11.1.min.js"><\/script>
<script src="/js/bootstrap.min.js"><\/script>
<script src="/js/prettify.js"><\/script>

<script>if (location.hostname === "localhost" || location.hostname === "127.0.0.1")
    document.write('<script src="http://'
    + (location.host || 'localhost').split(':')[0]
    + ':35729/livereload.js"></'
    + 'script>')<\/script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57796882-1', 'auto');
  ga('send', 'pageview');
<\/script>

<script data-execute="true">
  (function initLeafletComments() {
    const container = document.getElementById('leaflet-comments');
    if (!container) return;

    const statusId = 'leaflet-comments-status';
    const pathKey = location.pathname.replace(/^\\/+/, '');

    container.innerHTML = \`
      <hr class="text-muted" />
      <h3>Comments</h3>
      <p class="text-muted">Comments are mirrored from <a href="#" target="_blank" rel="noopener">Leaflet ↗</a>.</p>
      <p id="${statusId}">Loading comments...</p>
    \`;

    fetch('/leaflet-comments-map.json')
      .then((res) => {
        if (!res.ok) throw new Error('Map not found');
        return res.json();
      })
      .then(async (map) => {
        const mapping = map[pathKey] || map[\`/${pathKey}\`];
        if (!mapping) {
          setStatus('Comments not configured for this page.');
          return;
        }

        const leafLetUrl = typeof mapping === 'string' ? mapping : mapping.leafLetUrl;
        if (!leafLetUrl) {
          setStatus('Comments not configured for this page.');
          return;
        }

        const rkey = getRkeyFromUrl(leafLetUrl);
        if (!rkey) {
          setStatus('Could not determine comment thread.');
          return;
        }

        const did = 'did:plc:aldvhiaxmrkbewll3abu3roz';
        const collection = 'pub.leaflet.document';
        const atUri = \`at://${did}/${collection}/${rkey}\`;

        container.querySelector('.text-muted a')?.setAttribute('href', leafLetUrl);
        const records = [];
        let cursor = null;

        do {
          const res = await fetch(
            \`https://constellation.microcosm.blue/xrpc/blue.microcosm.links.getBacklinks?subject=${encodeURIComponent(
              atUri
            )}&source=pub.leaflet.comment:subject&limit=100${cursor ? \`&cursor=${cursor}\` : ''}\`
          );
          if (!res.ok) throw new Error(\`Backlinks request failed: ${res.status}\`);
          const data = await res.json();
          records.push(...(data.records || []));
          cursor = data.cursor;
        } while (cursor);

        if (!records.length) {
          setStatus('No comments yet.');
          return;
        }

        const comments = [];
        for (const record of records) {
          const recordUrl =
            \`https://slingshot.microcosm.blue/xrpc/com.atproto.repo.getRecord?\` +
            \`rkey=${encodeURIComponent(record.rkey)}&collection=${encodeURIComponent(
              record.collection
            )}&repo=${encodeURIComponent(record.did)}\`;

          const recordRes = await fetch(recordUrl, { headers: { Accept: 'application/json' } });
          if (!recordRes.ok) continue;
          const recordData = await recordRes.json();
          const value = recordData.value || {};

          // Resolve handle
          let handle = record.did;
          try {
            const handleRes = await fetch(
              \`https://slingshot.microcosm.blue/xrpc/com.bad-example.identity.resolveMiniDoc?identifier=${encodeURIComponent(
                record.did
              )}\`
            );
            if (handleRes.ok) {
              const handleData = await handleRes.json();
              if (handleData.handle) handle = handleData.handle;
            }
          } catch (err) {
            console.warn('Handle lookup failed', err);
          }

          comments.push({
            handle,
            createdAt: value.createdAt,
            text: value.plaintext || '',
            attachment: Boolean(value.attachment),
          });
        }

        clearStatus();
        renderComments(container, comments, leafLetUrl);
      })
      .catch((err) => {
        console.error('Failed to load Leaflet comments', err);
        setStatus('Could not load comments right now.');
      });

    function renderComments(containerEl, comments, leafLetUrl) {
      const list = document.createElement('div');
      list.className = 'leaflet-comments-list';

      comments
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
        .forEach((comment) => {
          const item = document.createElement('div');
          item.className = 'leaflet-comment mb-3';

          const header = document.createElement('div');
          header.className = 'd-flex justify-content-between';
          header.innerHTML = \`<strong>${escapeHtml(comment.handle)}</strong><span class="text-muted" style="margin-left:8px;">${relativeTime(
            comment.createdAt
          )}</span>\`;
          item.appendChild(header);

          if (comment.attachment) {
            const attachment = document.createElement('div');
            attachment.className = 'alert alert-info mt-2 mb-2';
            attachment.innerHTML = \`Quoted content. View on <a href="${leafLetUrl}" target="_blank" rel="noopener">leaflet.pub ↗</a>\`;
            item.appendChild(attachment);
          }

          const body = document.createElement('p');
          body.textContent = comment.text;
          item.appendChild(body);

          list.appendChild(item);
        });

      containerEl.appendChild(list);
    }

    function relativeTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = date - now;
      const diffSec = Math.round(diffMs / 1000);
      const intervals = [
        ['year', 60 * 60 * 24 * 365],
        ['month', 60 * 60 * 24 * 30],
        ['day', 60 * 60 * 24],
        ['hour', 60 * 60],
        ['minute', 60],
        ['second', 1],
      ];

      for (const [unit, secondsInUnit] of intervals) {
        const count = Math.trunc(diffSec / secondsInUnit);
        if (Math.abs(count) >= 1) {
          return new Intl.RelativeTimeFormat(undefined, { numeric: 'auto' }).format(count, unit);
        }
      }
      return 'just now';
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function setStatus(text) {
      const el = document.getElementById(statusId);
      if (el) el.textContent = text;
    }

    function clearStatus() {
      const el = document.getElementById(statusId);
      if (el) el.remove();
    }

    function getRkeyFromUrl(url) {
      try {
        const path = new URL(url).pathname;
        const parts = path.split('/').filter(Boolean);
        return parts[parts.length - 1] || null;
      } catch (e) {
        console.error('Invalid Leaflet URL', e);
        return null;
      }
    }
  })();
<\/script>
<!-- end scripts -->
`;
          }
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        await loadContent('/navbar.html', 'navbar-container');
        await loadContent('/footer.html', 'footer-container');

        if (typeof prettyPrint === 'function') {
          prettyPrint();
        }
      });
    </script>
  </body>
</html>
