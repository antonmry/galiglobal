<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Introduction to Go kit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="antonmry">
    <meta name="keywords" content="">
    <meta name="generator" content="generated-from-markdown">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">
  </head>
  <body>
    <div id="wrap">
      <div id="navbar-container"></div>
      <div class="container">
        <div id="content">
        <h1 id="introduction-to-go-kit">Introduction to Go kit</h1>
        <p><em>08 January 2017</em></p>
        <h2 id="microservices-dont-fit-all-use-cases">Microservices don't fit all use cases</h2>
        <p>When I've started <a href="https://github.com/antonmry/leanmanager">my Leanmanager bot</a>,
        I've chosen to use the same approach (well, really it's a framework but that
        word seems to be censured if you are a gopher so I will use <em>approach</em>) as the
        kubernetes project: if it's good for k8s, it should be good for me and also a
        good way to learn a bit more about kubernetes. So I've implemented all the REST
        APIs using
        <a href="https://github.com/emicklei/go-restful">github.com/emicklei/go-restful</a>.</p>
        <p>Then I had the opportunity to work a bit with <a href="https://gokit.io/">go-kit</a>. A
        framework, ups, no, sorry, a toolkit to create microservices. My initial opinion
        was too complicated and too much boilerplate. Yet I would like to give it
        another opportunity, there are some interesting things useful for bots (support
        many transports, RPC approach, instrumentation) and my main motivation with the
        bot is to test new technologies and ideas so... why not?</p>
        <p>If you visit the <a href="https://gokit.io">Go-kit website</a>, and then, you will jump
        very soon into the
        <a href="https://gokit.io/examples/stringsvc.html">stringsvc tutorial</a>. The tutorial is
        awesome but it isn't a five minutes read and it's a bit too complicated to start
        to work with Go-kit. I recommend an approach a bit different. First, watch
        <a href="https://www.youtube.com/watch?v=JXEjAwNWays">Go + Microservices = Go Kit</a> from
        <a href="https://peter.bourgon.org/">Peter Bourgon</a>. This is an awesome talk explaining
        microservices and their use cases. Clearly Peter knows a lot about the subject:
        microservices aren't for everyone.</p>
        <p>If after the video, you think microservices fit your case, go ahead and may the
        Force be with you.</p>
        <h2 id="go-kit-addsvc-example">Go-kit addsvc example</h2>
        <p>First step, download Go-kit:</p>
        <pre class="codehilite"><code class="language-sh">go get github.com/go-kit/kit
        </code></pre>

        <p>Then, just copy the
        <a href="https://github.com/go-kit/kit/tree/master/examples/addsvc">addsvc example</a> and
        download the dependencies (this may take a while depending of what you've
        already in the GOPATH).</p>
        <pre class="codehilite"><code class="language-sh">cp -r ../../go-kit/kit/examples/addsvc/ .
        go get ./...
        </code></pre>

        <p>The plan is simple, modify it to fit your use case while you are becoming more
        familiar with go-kit. But first, let's try the example. Launch the server:</p>
        <pre class="codehilite"><code class="language-sh">cd cmd/addsvc/
        go run main.go
        </code></pre>

        <p>And in a different shell, launch the client:</p>
        <pre class="codehilite"><code class="language-sh">cd cmd/addcli/
        go run main.go -http.addr=:8081 1 2
        </code></pre>

        <p>If everything goes well, you will obtain something like:</p>
        <blockquote>
        <p>1 + 2 = 3</p>
        </blockquote>
        <p>Or you can use <code>curl</code> directly:</p>
        <pre class="codehilite"><code class="language-sh">curl -H &quot;Content-Type: application/json&quot; -X POST -d '{&quot;A&quot;:&quot;xyz&quot;,&quot;B&quot;:&quot;abc&quot;}' http://localhost:8081/concat
        </code></pre>

        <p>There are some things to note now. First, the example has two methods, one for
        add numbers and another one to concat strings. Also, it supports many transport
        protocols, not only http, so you can launch the client using gRPC:</p>
        <pre class="codehilite"><code class="language-sh">go run main.go -grpc.addr=:8082 1 2
        </code></pre>

        <h2 id="show-me-the-code">Show me the code</h2>
        <p>It's time to go deeper. Open <code>service.go</code>. This is the file where the service
        definition is described and also implemented for this example.</p>
        <p>Note: I may continue this in the future if I resume my work with go-kit.</p>
        </div>
        
      </div>
      <div id="push"></div>
    </div>

    <div id="footer-container"></div>

    <script src="/js/jquery-1.11.1.min.js"></script>
    <script src="/js/bootstrap.min.js" defer></script>
    <script src="/js/prettify.js" defer></script>

    <script>
      async function loadContent(url, elementId) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const html = await response.text();
          const target = document.getElementById(elementId);
          if (!target) return;
          target.innerHTML = html;

          const scripts = target.querySelectorAll('script[data-execute="true"]');
          scripts.forEach((oldScript) => {
            const newScript = document.createElement('script');
            [...oldScript.attributes].forEach((attr) => newScript.setAttribute(attr.name, attr.value));
            newScript.textContent = oldScript.textContent;
            target.appendChild(newScript);
          });
        } catch (error) {
          console.error(`Error loading ${url}:`, error);
          // Fallback to embedded versions if available
          if (elementId === 'navbar-container' && `<!-- Fixed navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="/index.html">About</a></li>
                <li><a href="/blog-posts.html">Blog</a></li>
                <li><a href="/public-talks.html">Talks</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="https://bsky.app/profile/anton.galiglobal.com" aria-label="BlueSky"><i class="fa-brands fa-bluesky social-icon"></i></a></li>
                <li><a href="https://www.linkedin.com/in/antonmry/" aria-label="LinkedIn"><i class="fab fa-linkedin social-icon"></i></a></li>
                <li><a href="https://github.com/antonmry" aria-label="GitHub"><i class="fab fa-github-square social-icon"></i></a></li>
                <li><a href="https://blog.anton.galiglobal.com/rss" aria-label="RSS"><i class="fas fa-rss-square social-icon"></i></a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</div>
`) {
            const target = document.getElementById(elementId);
            if (target) target.innerHTML = `<!-- Fixed navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="/index.html">About</a></li>
                <li><a href="/blog-posts.html">Blog</a></li>
                <li><a href="/public-talks.html">Talks</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="https://bsky.app/profile/anton.galiglobal.com" aria-label="BlueSky"><i class="fa-brands fa-bluesky social-icon"></i></a></li>
                <li><a href="https://www.linkedin.com/in/antonmry/" aria-label="LinkedIn"><i class="fab fa-linkedin social-icon"></i></a></li>
                <li><a href="https://github.com/antonmry" aria-label="GitHub"><i class="fab fa-github-square social-icon"></i></a></li>
                <li><a href="https://blog.anton.galiglobal.com/rss" aria-label="RSS"><i class="fas fa-rss-square social-icon"></i></a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</div>
`;
          }
          if (elementId === 'footer-container' && `<!-- start footer -->
<div id="footer">
  <div class="container">
    <p class="muted credit"><span class="small"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"/></a>&nbsp;&nbsp;This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</span></p>
  </div>
</div>
<!-- end footer -->

<!-- start scripts -->
<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="/js/jquery-1.11.1.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/prettify.js"></script>

<script>if (location.hostname === "localhost" || location.hostname === "127.0.0.1")
    document.write('<script src="http://'
    + (location.host || 'localhost').split(':')[0]
    + ':35729/livereload.js"></'
    + 'script>')</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57796882-1', 'auto');
  ga('send', 'pageview');
</script>

<script data-execute="true">
  (function initLeafletComments() {
    const container = document.getElementById('leaflet-comments');
    if (!container) return;

    const statusId = 'leaflet-comments-status';
    const pathKey = location.pathname.replace(/^\\/+/, '');

    container.innerHTML = \`
      <hr class="text-muted" />
      <h3>Comments</h3>
      <p class="text-muted">Comments are mirrored from <a href="#" target="_blank" rel="noopener">Leaflet ↗</a>.</p>
      <p id="${statusId}">Loading comments...</p>
    \`;

    fetch('/leaflet-comments-map.json')
      .then((res) => {
        if (!res.ok) throw new Error('Map not found');
        return res.json();
      })
      .then(async (map) => {
        const mapping = map[pathKey] || map[\`/${pathKey}\`];
        if (!mapping) {
          setStatus('Comments not configured for this page.');
          return;
        }

        const leafLetUrl = typeof mapping === 'string' ? mapping : mapping.leafLetUrl;
        if (!leafLetUrl) {
          setStatus('Comments not configured for this page.');
          return;
        }

        const rkey = getRkeyFromUrl(leafLetUrl);
        if (!rkey) {
          setStatus('Could not determine comment thread.');
          return;
        }

        const did = 'did:plc:aldvhiaxmrkbewll3abu3roz';
        const collection = 'pub.leaflet.document';
        const atUri = \`at://${did}/${collection}/${rkey}\`;

        container.querySelector('.text-muted a')?.setAttribute('href', leafLetUrl);
        const records = [];
        let cursor = null;

        do {
          const res = await fetch(
            \`https://constellation.microcosm.blue/xrpc/blue.microcosm.links.getBacklinks?subject=${encodeURIComponent(
              atUri
            )}&source=pub.leaflet.comment:subject&limit=100${cursor ? \`&cursor=${cursor}\` : ''}\`
          );
          if (!res.ok) throw new Error(\`Backlinks request failed: ${res.status}\`);
          const data = await res.json();
          records.push(...(data.records || []));
          cursor = data.cursor;
        } while (cursor);

        if (!records.length) {
          setStatus('No comments yet.');
          return;
        }

        const comments = [];
        for (const record of records) {
          const recordUrl =
            \`https://slingshot.microcosm.blue/xrpc/com.atproto.repo.getRecord?\` +
            \`rkey=${encodeURIComponent(record.rkey)}&collection=${encodeURIComponent(
              record.collection
            )}&repo=${encodeURIComponent(record.did)}\`;

          const recordRes = await fetch(recordUrl, { headers: { Accept: 'application/json' } });
          if (!recordRes.ok) continue;
          const recordData = await recordRes.json();
          const value = recordData.value || {};

          // Resolve handle
          let handle = record.did;
          try {
            const handleRes = await fetch(
              \`https://slingshot.microcosm.blue/xrpc/com.bad-example.identity.resolveMiniDoc?identifier=${encodeURIComponent(
                record.did
              )}\`
            );
            if (handleRes.ok) {
              const handleData = await handleRes.json();
              if (handleData.handle) handle = handleData.handle;
            }
          } catch (err) {
            console.warn('Handle lookup failed', err);
          }

          comments.push({
            handle,
            createdAt: value.createdAt,
            text: value.plaintext || '',
            attachment: Boolean(value.attachment),
          });
        }

        clearStatus();
        renderComments(container, comments, leafLetUrl);
      })
      .catch((err) => {
        console.error('Failed to load Leaflet comments', err);
        setStatus('Could not load comments right now.');
      });

    function renderComments(containerEl, comments, leafLetUrl) {
      const list = document.createElement('div');
      list.className = 'leaflet-comments-list';

      comments
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
        .forEach((comment) => {
          const item = document.createElement('div');
          item.className = 'leaflet-comment mb-3';

          const header = document.createElement('div');
          header.className = 'd-flex justify-content-between';
          header.innerHTML = \`<strong>${escapeHtml(comment.handle)}</strong><span class="text-muted" style="margin-left:8px;">${relativeTime(
            comment.createdAt
          )}</span>\`;
          item.appendChild(header);

          if (comment.attachment) {
            const attachment = document.createElement('div');
            attachment.className = 'alert alert-info mt-2 mb-2';
            attachment.innerHTML = \`Quoted content. View on <a href="${leafLetUrl}" target="_blank" rel="noopener">leaflet.pub ↗</a>\`;
            item.appendChild(attachment);
          }

          const body = document.createElement('p');
          body.textContent = comment.text;
          item.appendChild(body);

          list.appendChild(item);
        });

      containerEl.appendChild(list);
    }

    function relativeTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = date - now;
      const diffSec = Math.round(diffMs / 1000);
      const intervals = [
        ['year', 60 * 60 * 24 * 365],
        ['month', 60 * 60 * 24 * 30],
        ['day', 60 * 60 * 24],
        ['hour', 60 * 60],
        ['minute', 60],
        ['second', 1],
      ];

      for (const [unit, secondsInUnit] of intervals) {
        const count = Math.trunc(diffSec / secondsInUnit);
        if (Math.abs(count) >= 1) {
          return new Intl.RelativeTimeFormat(undefined, { numeric: 'auto' }).format(count, unit);
        }
      }
      return 'just now';
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function setStatus(text) {
      const el = document.getElementById(statusId);
      if (el) el.textContent = text;
    }

    function clearStatus() {
      const el = document.getElementById(statusId);
      if (el) el.remove();
    }

    function getRkeyFromUrl(url) {
      try {
        const path = new URL(url).pathname;
        const parts = path.split('/').filter(Boolean);
        return parts[parts.length - 1] || null;
      } catch (e) {
        console.error('Invalid Leaflet URL', e);
        return null;
      }
    }
  })();
</script>
<!-- end scripts -->
`) {
            const target = document.getElementById(elementId);
            if (target) target.innerHTML = `<!-- start footer -->
<div id="footer">
  <div class="container">
    <p class="muted credit"><span class="small"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"/></a>&nbsp;&nbsp;This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</span></p>
  </div>
</div>
<!-- end footer -->

<!-- start scripts -->
<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="/js/jquery-1.11.1.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/prettify.js"></script>

<script>if (location.hostname === "localhost" || location.hostname === "127.0.0.1")
    document.write('<script src="http://'
    + (location.host || 'localhost').split(':')[0]
    + ':35729/livereload.js"></'
    + 'script>')</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57796882-1', 'auto');
  ga('send', 'pageview');
</script>

<script data-execute="true">
  (function initLeafletComments() {
    const container = document.getElementById('leaflet-comments');
    if (!container) return;

    const statusId = 'leaflet-comments-status';
    const pathKey = location.pathname.replace(/^\\/+/, '');

    container.innerHTML = \`
      <hr class="text-muted" />
      <h3>Comments</h3>
      <p class="text-muted">Comments are mirrored from <a href="#" target="_blank" rel="noopener">Leaflet ↗</a>.</p>
      <p id="${statusId}">Loading comments...</p>
    \`;

    fetch('/leaflet-comments-map.json')
      .then((res) => {
        if (!res.ok) throw new Error('Map not found');
        return res.json();
      })
      .then(async (map) => {
        const mapping = map[pathKey] || map[\`/${pathKey}\`];
        if (!mapping) {
          setStatus('Comments not configured for this page.');
          return;
        }

        const leafLetUrl = typeof mapping === 'string' ? mapping : mapping.leafLetUrl;
        if (!leafLetUrl) {
          setStatus('Comments not configured for this page.');
          return;
        }

        const rkey = getRkeyFromUrl(leafLetUrl);
        if (!rkey) {
          setStatus('Could not determine comment thread.');
          return;
        }

        const did = 'did:plc:aldvhiaxmrkbewll3abu3roz';
        const collection = 'pub.leaflet.document';
        const atUri = \`at://${did}/${collection}/${rkey}\`;

        container.querySelector('.text-muted a')?.setAttribute('href', leafLetUrl);
        const records = [];
        let cursor = null;

        do {
          const res = await fetch(
            \`https://constellation.microcosm.blue/xrpc/blue.microcosm.links.getBacklinks?subject=${encodeURIComponent(
              atUri
            )}&source=pub.leaflet.comment:subject&limit=100${cursor ? \`&cursor=${cursor}\` : ''}\`
          );
          if (!res.ok) throw new Error(\`Backlinks request failed: ${res.status}\`);
          const data = await res.json();
          records.push(...(data.records || []));
          cursor = data.cursor;
        } while (cursor);

        if (!records.length) {
          setStatus('No comments yet.');
          return;
        }

        const comments = [];
        for (const record of records) {
          const recordUrl =
            \`https://slingshot.microcosm.blue/xrpc/com.atproto.repo.getRecord?\` +
            \`rkey=${encodeURIComponent(record.rkey)}&collection=${encodeURIComponent(
              record.collection
            )}&repo=${encodeURIComponent(record.did)}\`;

          const recordRes = await fetch(recordUrl, { headers: { Accept: 'application/json' } });
          if (!recordRes.ok) continue;
          const recordData = await recordRes.json();
          const value = recordData.value || {};

          // Resolve handle
          let handle = record.did;
          try {
            const handleRes = await fetch(
              \`https://slingshot.microcosm.blue/xrpc/com.bad-example.identity.resolveMiniDoc?identifier=${encodeURIComponent(
                record.did
              )}\`
            );
            if (handleRes.ok) {
              const handleData = await handleRes.json();
              if (handleData.handle) handle = handleData.handle;
            }
          } catch (err) {
            console.warn('Handle lookup failed', err);
          }

          comments.push({
            handle,
            createdAt: value.createdAt,
            text: value.plaintext || '',
            attachment: Boolean(value.attachment),
          });
        }

        clearStatus();
        renderComments(container, comments, leafLetUrl);
      })
      .catch((err) => {
        console.error('Failed to load Leaflet comments', err);
        setStatus('Could not load comments right now.');
      });

    function renderComments(containerEl, comments, leafLetUrl) {
      const list = document.createElement('div');
      list.className = 'leaflet-comments-list';

      comments
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
        .forEach((comment) => {
          const item = document.createElement('div');
          item.className = 'leaflet-comment mb-3';

          const header = document.createElement('div');
          header.className = 'd-flex justify-content-between';
          header.innerHTML = \`<strong>${escapeHtml(comment.handle)}</strong><span class="text-muted" style="margin-left:8px;">${relativeTime(
            comment.createdAt
          )}</span>\`;
          item.appendChild(header);

          if (comment.attachment) {
            const attachment = document.createElement('div');
            attachment.className = 'alert alert-info mt-2 mb-2';
            attachment.innerHTML = \`Quoted content. View on <a href="${leafLetUrl}" target="_blank" rel="noopener">leaflet.pub ↗</a>\`;
            item.appendChild(attachment);
          }

          const body = document.createElement('p');
          body.textContent = comment.text;
          item.appendChild(body);

          list.appendChild(item);
        });

      containerEl.appendChild(list);
    }

    function relativeTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = date - now;
      const diffSec = Math.round(diffMs / 1000);
      const intervals = [
        ['year', 60 * 60 * 24 * 365],
        ['month', 60 * 60 * 24 * 30],
        ['day', 60 * 60 * 24],
        ['hour', 60 * 60],
        ['minute', 60],
        ['second', 1],
      ];

      for (const [unit, secondsInUnit] of intervals) {
        const count = Math.trunc(diffSec / secondsInUnit);
        if (Math.abs(count) >= 1) {
          return new Intl.RelativeTimeFormat(undefined, { numeric: 'auto' }).format(count, unit);
        }
      }
      return 'just now';
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function setStatus(text) {
      const el = document.getElementById(statusId);
      if (el) el.textContent = text;
    }

    function clearStatus() {
      const el = document.getElementById(statusId);
      if (el) el.remove();
    }

    function getRkeyFromUrl(url) {
      try {
        const path = new URL(url).pathname;
        const parts = path.split('/').filter(Boolean);
        return parts[parts.length - 1] || null;
      } catch (e) {
        console.error('Invalid Leaflet URL', e);
        return null;
      }
    }
  })();
</script>
<!-- end scripts -->
`;
          }
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        await loadContent('/navbar.html', 'navbar-container');
        await loadContent('/footer.html', 'footer-container');

        if (typeof prettyPrint === 'function') {
          prettyPrint();
        }
      });
    </script>
  </body>
</html>
