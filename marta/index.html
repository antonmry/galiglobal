<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>Intervalos de carrera</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root {
      --bg:#0f172a;
      --card:#1e253a;
      --text:#f8fafc;
      --sub:#94a3b8;
      --accent:#38bdf8;
      --good:#4ade80;
      --hard:#facc15;
    }

    * {
      box-sizing:border-box;
      -webkit-font-smoothing: antialiased;
      font-family: system-ui,-apple-system, BlinkMacSystemFont,"Inter","Roboto","Segoe UI",sans-serif;
    }

    body {
      margin:0;
      background:var(--bg);
      color:var(--text);
      display:flex;
      min-height:100vh;
      align-items:center;
      justify-content:center;
      padding:1.5rem;
    }

    .card {
      background:var(--card);
      width:100%;
      max-width:420px;
      border-radius:1rem;
      padding:1.5rem 1.5rem 2rem;
      box-shadow:0 30px 80px rgba(0,0,0,.6);
      display:flex;
      flex-direction:column;
      gap:1.25rem;
    }

    header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
    }

    .title-block {
      display:flex;
      flex-direction:column;
      gap:.25rem;
    }

    .title {
      font-size:1rem;
      font-weight:600;
      color:var(--text);
      line-height:1.2;
      cursor:default;
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      transition:color .2s ease;
    }

    .title[role="button"] {
      cursor:pointer;
    }

    .title[role="button"]::after {
      content:"▼";
      font-size:.65rem;
      color:var(--sub);
      transform:scaleX(1.1);
    }

    .title[role="button"]:hover,
    .title[role="button"]:focus-visible {
      color:var(--accent);
    }

    .title[role="button"]:focus-visible {
      outline:2px solid rgba(56,189,248,.6);
      outline-offset:3px;
    }

    .phase {
      font-size:.875rem;
      line-height:1.2;
      color:var(--sub);
    }

    .bpm-chip {
      background:rgba(56,189,248,.1);
      color:var(--accent);
      font-size:.875rem;
      line-height:1.2;
      font-weight:500;
      padding:.5rem .75rem;
      border-radius:.5rem;
      min-width:88px;
      text-align:center;
    }

    .timer-block {
      text-align:center;
    }

    .time-display {
      font-size:3.5rem;
      font-weight:600;
      line-height:1;
      letter-spacing:-.05em;
      color:var(--text);
    }

    .subrow {
      margin-top:.5rem;
      font-size:.875rem;
      color:var(--sub);
      line-height:1.2;
      display:flex;
      justify-content:center;
      gap:.5rem;
      flex-wrap:wrap;
    }

    .progress-wrapper {
      background:rgba(148,163,184,.15);
      height:6px;
      border-radius:999px;
      overflow:hidden;
      margin-top:1rem;
    }

    .progress-bar {
      background:var(--accent);
      height:100%;
      width:0%;
      transition:width .2s linear;
    }

    .controls {
      display:flex;
      gap:.75rem;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:.5rem;
    }

    .card-footer {
      margin-top:auto;
      display:flex;
      justify-content:center;
    }

    button.footer-btn {
      flex:1;
      min-width:140px;
      background:#334155;
      color:var(--text);
      border:1px solid rgba(148,163,184,.25);
      border-radius:.75rem;
      padding:.75rem 1rem;
      font-size:.95rem;
      font-weight:500;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      transition:background .2s ease, color .2s ease;
    }

    button.footer-btn.primary {
      background:rgba(56,189,248,.15);
      color:var(--accent);
      border-color:rgba(56,189,248,.4);
    }

    button.footer-btn.primary:hover {
      background:rgba(56,189,248,.3);
    }

    button.footer-btn:active {
      transform:scale(.98);
    }

    button.ctrl {
      flex:1;
      min-width:90px;
      background:#334155;
      color:var(--text);
      border:0;
      border-radius:.75rem;
      padding:.75rem 1rem;
      font-size:1rem;
      font-weight:500;
      line-height:1.2;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
    }
    button.ctrl.main {
      background:var(--accent);
      color:#0f172a;
      font-weight:600;
    }
    button.ctrl:active {
      transform:scale(.98);
    }

    .plan {
      background:#0f172a;
      border-radius:.75rem;
      padding:1rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
    }

    .plan-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:.5rem;
    }

    .plan-title {
      font-size:.95rem;
      font-weight:600;
      color:var(--text);
    }

    .plan-total {
      font-size:.8rem;
      color:var(--sub);
    }

    .plan-workout-name {
      font-size:.8rem;
      color:var(--sub);
    }

    .plan-list {
      display:flex;
      flex-direction:column;
      gap:.75rem;
    }

    .plan-item {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:.75rem;
      padding:.85rem;
      background:#111a2e;
      border-radius:.75rem;
      border:1px solid rgba(148,163,184,.15);
    }

    .plan-item-main {
      display:flex;
      flex-direction:column;
      gap:.25rem;
    }

    .plan-item-label {
      font-weight:500;
      color:var(--text);
      font-size:.9rem;
      line-height:1.3;
    }

    .plan-item-desc {
      color:var(--sub);
      font-size:.8rem;
      line-height:1.3;
    }

    .plan-item-meta {
      text-align:right;
      min-width:4rem;
      font-size:.8rem;
      line-height:1.3;
      color:var(--sub);
    }

    .config-panel {
      background:#111a2e;
      border-radius:.75rem;
      padding:1rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
      border:1px solid rgba(148,163,184,.15);
    }

    .workout-panel {
      background:#111a2e;
      border-radius:.75rem;
      padding:1rem;
      border:1px solid rgba(148,163,184,.15);
      display:flex;
      flex-direction:column;
      gap:.85rem;
    }

    .workout-row {
      display:flex;
      gap:.75rem;
      flex-wrap:wrap;
      align-items:flex-end;
    }

    .workout-field {
      flex:1 1 160px;
      display:flex;
      flex-direction:column;
      gap:.35rem;
    }

    .workout-field label {
      font-size:.75rem;
      color:var(--sub);
      text-transform:uppercase;
      letter-spacing:.04em;
    }

    #workoutSelect,
    #workoutNameInput {
      background:#1e253a;
      border:1px solid rgba(148,163,184,.25);
      border-radius:.55rem;
      padding:.55rem .65rem;
      color:var(--text);
      font-size:.9rem;
      width:100%;
    }

    #workoutSelect:focus,
    #workoutNameInput:focus {
      outline:2px solid rgba(56,189,248,.6);
      outline-offset:2px;
    }

    .workout-actions {
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
    }

    .workout-btn {
      background:#334155;
      color:var(--text);
      border:1px solid rgba(148,163,184,.25);
      border-radius:.65rem;
      padding:.55rem .85rem;
      font-size:.85rem;
      font-weight:500;
      cursor:pointer;
      transition:background .2s ease, color .2s ease;
    }

    .workout-btn:hover {
      background:rgba(56,189,248,.2);
      color:var(--accent);
    }

    .workout-btn:disabled {
      opacity:.4;
      cursor:default;
    }

    .config-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:.75rem;
    }

    .config-title {
      font-size:.95rem;
      font-weight:600;
      color:var(--text);
    }

    .config-add-btn,
    .config-apply-btn,
    .config-export-btn,
    .config-import-btn,
    .stage-remove-btn,
    .stage-move-btn {
      background:#334155;
      color:var(--text);
      border:1px solid rgba(148,163,184,.25);
      border-radius:.65rem;
      padding:.6rem .9rem;
      font-size:.85rem;
      font-weight:500;
      cursor:pointer;
      transition:background .2s ease, color .2s ease;
    }

    .config-add-btn:hover,
    .config-apply-btn:hover,
    .config-export-btn:hover,
    .config-import-btn:hover,
    .stage-remove-btn:hover,
    .stage-move-btn:hover {
      background:rgba(56,189,248,.15);
      color:var(--accent);
    }

    .config-stages {
      display:flex;
      flex-direction:column;
      gap:.9rem;
    }

    .config-empty {
      font-size:.85rem;
      color:var(--sub);
    }

    .stage-card {
      background:#0f172a;
      border-radius:.75rem;
      border:1px solid rgba(148,163,184,.15);
      padding:.9rem;
      display:flex;
      flex-direction:column;
      gap:.75rem;
    }

    .stage-row {
      display:flex;
      flex-wrap:wrap;
      gap:.75rem;
    }

    .stage-field {
      flex:1 1 140px;
      display:flex;
      flex-direction:column;
      gap:.35rem;
    }

    .stage-field label {
      font-size:.75rem;
      color:var(--sub);
      text-transform:uppercase;
      letter-spacing:.04em;
    }

    .stage-field input,
    .stage-field select {
      background:#1e253a;
      border:1px solid rgba(148,163,184,.25);
      border-radius:.55rem;
      padding:.55rem .65rem;
      color:var(--text);
      font-size:.9rem;
      width:100%;
    }

    .stage-field input:focus,
    .stage-field select:focus {
      outline:2px solid rgba(56,189,248,.6);
      outline-offset:2px;
    }

    .stage-split-toggle {
      display:flex;
      align-items:center;
      gap:.5rem;
      font-size:.8rem;
      color:var(--sub);
      margin-top:.25rem;
    }

    .stage-split-toggle input {
      width:auto;
      accent-color:var(--accent);
    }

    .stage-subphase {
      padding:.75rem;
      border-radius:.65rem;
      background:#111a2e;
      border:1px solid rgba(148,163,184,.15);
      display:flex;
      flex-direction:column;
      gap:.75rem;
      margin-top:.35rem;
    }

    .stage-subphase-heading {
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:var(--sub);
    }

    .stage-actions {
      display:flex;
      justify-content:flex-end;
      gap:.5rem;
      flex-wrap:wrap;
    }

    .config-apply-btn {
      align-self:auto;
    }

    .stage-move-btn:disabled {
      opacity:.35;
      cursor:default;
    }

    .config-feedback {
      font-size:.8rem;
      color:var(--sub);
      min-height:1.1rem;
      text-align:right;
      padding-right:.1rem;
      margin-bottom:.5rem;
    }

    .config-feedback.error {
      color:#f87171;
    }

    .config-feedback.success {
      color:#4ade80;
    }

    .config-screen {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.95);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:2rem 1.5rem;
      overflow-y:auto;
      z-index:10;
    }

    .config-screen[hidden] {
      display:none;
    }

    .config-shell {
      width:min(640px,92vw);
      background:#0f172a;
      border-radius:1rem;
      border:1px solid rgba(148,163,184,.2);
      box-shadow:0 40px 120px rgba(0,0,0,.55);
      padding:1.5rem;
      display:flex;
      flex-direction:column;
      gap:1.25rem;
    }

    .config-screen-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
    }

    .config-screen-actions {
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
    }

    .config-screen-title {
      font-size:1.05rem;
      font-weight:600;
      color:var(--text);
    }

    .session-picker {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.92);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:2rem 1.5rem;
      z-index:12;
    }

    .session-picker[hidden] {
      display:none;
    }

    .session-picker-panel {
      width:min(360px,92vw);
      background:#0f172a;
      border-radius:.9rem;
      border:1px solid rgba(148,163,184,.25);
      box-shadow:0 32px 110px rgba(0,0,0,.55);
      padding:1.25rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
    }

    .session-picker-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.75rem;
    }

    .session-picker-title {
      font-size:1rem;
      font-weight:600;
      color:var(--text);
    }

    .session-picker-close {
      background:transparent;
      border:1px solid rgba(148,163,184,.35);
      color:var(--sub);
      border-radius:.6rem;
      padding:.4rem .75rem;
      font-size:.8rem;
      font-weight:500;
      cursor:pointer;
      transition:background .2s ease, color .2s ease;
    }

    .session-picker-close:hover,
    .session-picker-close:focus-visible {
      color:var(--accent);
      background:rgba(56,189,248,.12);
      outline:0;
    }

    .session-picker-list {
      display:flex;
      flex-direction:column;
      gap:.65rem;
    }

    .session-picker-item {
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:.2rem;
      width:100%;
      padding:.75rem .95rem;
      background:#111a2e;
      border:1px solid rgba(148,163,184,.25);
      border-radius:.7rem;
      color:var(--text);
      font-size:.9rem;
      text-align:left;
      cursor:pointer;
      transition:background .2s ease, border-color .2s ease, color .2s ease;
    }

    .session-picker-item:hover {
      border-color:rgba(56,189,248,.35);
    }

    .session-picker-item:focus-visible {
      outline:2px solid rgba(56,189,248,.6);
      outline-offset:3px;
    }

    .session-picker-item.active {
      border-color:rgba(56,189,248,.6);
      color:var(--accent);
    }

    .session-picker-item .session-picker-meta {
      font-size:.75rem;
      color:var(--sub);
    }

    .session-picker-item.active .session-picker-meta {
      color:var(--accent);
    }

    .session-picker-name {
      font-weight:600;
    }

    .config-close-btn {
      background:#334155;
      color:var(--text);
      border:1px solid rgba(148,163,184,.25);
      border-radius:.65rem;
      padding:.55rem .9rem;
      font-size:.85rem;
      font-weight:500;
      cursor:pointer;
      transition:background .2s ease, color .2s ease;
    }

    .config-close-btn:hover {
      background:rgba(56,189,248,.2);
      color:var(--accent);
    }

    body.modal-open {
      overflow:hidden;
    }

    .bottom-controls {
      margin-top:1.5rem;
      display:flex;
      gap:.75rem;
      flex-wrap:wrap;
      justify-content:center;
    }

    .hrm-panel {
      background:rgba(15,23,42,.65);
      border-radius:.85rem;
      padding:1.25rem;
      display:grid;
      gap:1rem;
      text-align:center;
      border:1px solid rgba(148,163,184,.15);
    }

    .hrm-title {
      font-size:.85rem;
      font-weight:600;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--sub);
      margin:0;
    }

    #hrmBpmValue {
      font-size:2.75rem;
      font-weight:700;
    }

    #hrmBpmValue span {
      font-size:1rem;
      color:var(--sub);
      margin-left:.5rem;
    }

    #hrmBpmValue span:first-child {
      font-size:2.75rem;
      margin-left:0;
      color:inherit;
    }

    #hrmBpmValue.in-range {
      color:var(--good);
    }

    #hrmBpmValue.low-range {
      color:var(--hard);
    }

    #hrmBpmValue.high-range {
      color:#f87171;
    }

    .hrm-range-status {
      font-size:.8rem;
      color:var(--sub);
      min-height:1.2rem;
    }

    .hrm-range-status.in-range {
      color:var(--good);
    }

    .hrm-range-status.low-range {
      color:var(--hard);
    }

    .hrm-range-status.high-range {
      color:#f87171;
    }

    #hrmChart {
      width:100%;
      height:140px;
      border-radius:.75rem;
      background:rgba(15,23,42,0.7);
      border:1px solid rgba(148,163,184,0.15);
    }

    #hrmToggleBtn {
      background:var(--accent);
      border:none;
      border-radius:.75rem;
      padding:.85rem 1rem;
      color:#0b1120;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease;
      box-shadow:0 18px 40px rgba(56,189,248,.45);
    }

    #hrmToggleBtn:active {
      transform:translateY(1px);
      box-shadow:0 12px 24px rgba(56,189,248,.35);
    }

    #hrmToggleBtn.disconnected {
      background:transparent;
      color:var(--text);
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:none;
    }

    #hrmStatus {
      font-size:.85rem;
      color:var(--sub);
      min-height:1.5rem;
    }
  </style>
</head>
<body>
  <main class="card">
    <header>
      <div class="title-block">
        <div class="title" id="sessionTitle" role="button" tabindex="0" aria-haspopup="dialog" aria-expanded="false">Sesión de intervalos</div>
        <div class="phase" id="currentPhaseLabel">Listo</div>
      </div>
      <div class="bpm-chip" id="bpmTarget">-- bpm</div>
    </header>

    <section class="timer-block">
      <div class="time-display" id="timeDisplay">00:00</div>
      <div class="subrow">
        <span id="subStatus">Pulsa Iniciar</span>
        <span id="intervalCount"></span>
      </div>

      <div class="progress-wrapper">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <div class="controls">
        <button class="ctrl main" id="startPauseBtn">Iniciar</button>
        <button class="ctrl" id="skip10Btn">Saltar 10s</button>
        <button class="ctrl" id="skipBtn">Saltar fase</button>
      </div>
    </section>

    <footer class="card-footer">
      <button class="footer-btn primary" id="fullscreenToggleBtn">Pantalla completa</button>
    </footer>

    <section class="hrm-panel" aria-labelledby="hrmPanelTitle">
      <h2 class="hrm-title" id="hrmPanelTitle">Sesión HR</h2>
      <div id="hrmBpmValue"><span id="hrmBpmNumber">--</span><span>bpm</span></div>
      <div class="hrm-range-status" id="hrmRangeStatus" aria-live="polite"></div>
      <canvas id="hrmChart" role="img" aria-label="Historial de ritmo cardíaco"></canvas>
      <button id="hrmToggleBtn" class="disconnected">Conectar banda</button>
      <div id="hrmStatus" aria-live="polite">Listo para conectar.</div>
    </section>
    <div class="bottom-controls" role="region" aria-label="Controles de sesión">
      <button class="footer-btn" id="configOpenBtn">Configurar</button>
      <button class="footer-btn" id="resetBtn">Reiniciar</button>
      <button class="footer-btn" id="installBtn" hidden>Instalar app</button>
    </div>
  </main>

  <div class="session-picker" id="sessionPicker" hidden role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="sessionPickerTitle" tabindex="-1">
    <div class="session-picker-panel">
      <div class="session-picker-header">
        <h2 class="session-picker-title" id="sessionPickerTitle">Seleccionar sesión</h2>
        <button class="session-picker-close" id="sessionPickerCloseBtn" type="button">Cerrar</button>
      </div>
      <div class="session-picker-list" id="sessionPickerList" role="listbox" aria-label="Sesiones disponibles"></div>
    </div>
  </div>

  <section class="config-screen" id="configScreen" hidden role="dialog" aria-modal="true" aria-labelledby="configScreenTitle" aria-hidden="true" tabindex="-1">
    <div class="config-shell">
      <header class="config-screen-header">
        <h2 class="config-screen-title" id="configScreenTitle">Configurar sesión</h2>
        <div class="config-screen-actions">
          <button class="config-apply-btn" id="configApplyBtn" type="button">Guardar</button>
          <button class="config-close-btn" id="configCloseBtn" type="button">Cerrar</button>
          <button class="config-export-btn" id="configExportBtn" type="button">Descargar</button>
          <button class="config-import-btn" id="configImportBtn" type="button">Subir</button>
        </div>
      </header>

      <div class="config-feedback" id="configFeedback" aria-live="polite"></div>

      <section class="workout-panel" aria-labelledby="workoutPickerTitle">
        <div class="workout-row">
          <div class="workout-field">
            <label for="workoutSelect" id="workoutPickerTitle">Entrenamiento</label>
            <select id="workoutSelect"></select>
          </div>
          <div class="workout-actions">
            <button class="workout-btn" id="workoutAddBtn" type="button">Nuevo</button>
            <button class="workout-btn" id="workoutDuplicateBtn" type="button">Duplicar</button>
            <button class="workout-btn" id="workoutDeleteBtn" type="button">Eliminar</button>
          </div>
        </div>
        <div class="workout-field">
          <label for="workoutNameInput">Nombre del entrenamiento</label>
          <input id="workoutNameInput" type="text" maxlength="60" placeholder="Ej. Series tempo" />
        </div>
      </section>

      <section class="config-panel" aria-labelledby="configTitle">
        <div class="config-header">
          <h3 class="config-title" id="configTitle">Intervalos</h3>
          <button class="config-add-btn" id="configAddStageBtn" type="button">Añadir etapa</button>
        </div>
        <div class="config-stages" id="configStagesContainer"></div>
      </section>

      <input type="file" id="configImportInput" accept="application/json" hidden />

      <section class="plan" aria-labelledby="planTitle">
        <div class="plan-header">
          <h3 class="plan-title" id="planTitle">Resumen de etapas</h3>
          <div class="plan-total" id="planTotalDuration"></div>
        </div>
        <div class="plan-workout-name" id="planWorkoutName"></div>
        <div class="plan-list" id="planList"></div>
      </section>
    </div>
  </section>

  <script>
    // --- Configuración de etapas ---
    let stageIdCounter = 0;
    let workoutIdCounter = 0;

    function sanitizePositiveInt(value, fallback, { min = 0, max = Infinity } = {}) {
      const numeric = Number(value);
      if (!Number.isFinite(numeric)) {
        return fallback;
      }
      const clamped = Math.min(Math.max(Math.floor(numeric), min), max);
      return clamped;
    }

    function createStage({ name, repeats, minutes, seconds, bpmMin, bpmMax, type, split, secondaryName, secondaryType, secondaryMinutes, secondarySeconds, secondaryBpmMin, secondaryBpmMax }) {
      const repeatValue = sanitizePositiveInt(repeats, 1, { min: 1 });
      const minuteValue = sanitizePositiveInt(minutes, 0, { min: 0 });
      const secondValue = sanitizePositiveInt(seconds, 0, { min: 0, max: 59 });
      const secondaryMinuteValue = sanitizePositiveInt(secondaryMinutes, 0, { min: 0 });
      const secondarySecondValue = sanitizePositiveInt(secondarySeconds, 0, { min: 0, max: 59 });
      return {
        id: `stage-${++stageIdCounter}`,
        name: name || "",
        repeats: repeatValue,
        minutes: minuteValue,
        seconds: secondValue,
        bpmMin: bpmMin === "" || bpmMin == null ? "" : Number(bpmMin),
        bpmMax: bpmMax === "" || bpmMax == null ? "" : Number(bpmMax),
        type: type || "custom",
        split: Boolean(split),
        secondaryName: secondaryName || "",
        secondaryType: secondaryType || "rest",
        secondaryMinutes: secondaryMinuteValue,
        secondarySeconds: secondarySecondValue,
        secondaryBpmMin: secondaryBpmMin === "" || secondaryBpmMin == null ? "" : Number(secondaryBpmMin),
        secondaryBpmMax: secondaryBpmMax === "" || secondaryBpmMax == null ? "" : Number(secondaryBpmMax)
      };
    }

    function cloneStage(stage) {
      return {
        id: stage.id,
        name: stage.name,
        repeats: stage.repeats,
        minutes: stage.minutes,
        seconds: stage.seconds,
        bpmMin: stage.bpmMin === "" ? "" : Number(stage.bpmMin),
        bpmMax: stage.bpmMax === "" ? "" : Number(stage.bpmMax),
        type: stage.type,
        split: Boolean(stage.split),
        secondaryName: stage.secondaryName || "",
        secondaryType: stage.secondaryType || "rest",
        secondaryMinutes: sanitizePositiveInt(stage.secondaryMinutes, 0, { min: 0 }),
        secondarySeconds: sanitizePositiveInt(stage.secondarySeconds, 0, { min: 0, max: 59 }),
        secondaryBpmMin: stage.secondaryBpmMin === "" ? "" : Number(stage.secondaryBpmMin),
        secondaryBpmMax: stage.secondaryBpmMax === "" ? "" : Number(stage.secondaryBpmMax)
      };
    }

    function generateWorkoutId() {
      workoutIdCounter += 1;
      return `workout-${Date.now()}-${workoutIdCounter}`;
    }

    function cloneWorkout(workout) {
      return {
        id: workout.id || generateWorkoutId(),
        name: workout.name || fallbackWorkoutName,
        stages: workout.stages.map(cloneStage),
        drafts: workout.drafts ? workout.drafts.map(cloneStage) : null
      };
    }

    function generateWorkoutName(base) {
      const used = new Set(workouts.map(function(item){ return item.name; }));
      let candidate = (base && base.trim()) || `${fallbackWorkoutName} ${workouts.length + 1}`;
      if (!used.has(candidate)) {
        return candidate;
      }
      let suffix = 2;
      while (used.has(`${candidate} (${suffix})`)) {
        suffix += 1;
      }
      return `${candidate} (${suffix})`;
    }

    const STORAGE_KEY = "workoutConfigs.v1";
    let storageAvailableMemo = null;

    function isStorageAvailable() {
      if (storageAvailableMemo != null) {
        return storageAvailableMemo;
      }
      if (typeof window === "undefined" || typeof window.localStorage === "undefined") {
        storageAvailableMemo = false;
        return storageAvailableMemo;
      }
      try {
        const testKey = "__workout_cfg_test__";
        localStorage.setItem(testKey, "1");
        localStorage.removeItem(testKey);
        storageAvailableMemo = true;
      } catch (err) {
        storageAvailableMemo = false;
      }
      return storageAvailableMemo;
    }

    function persistWorkouts() {
      if (!isStorageAvailable()) return;
      try {
        const payload = {
          workouts: workouts.map(function(workout){
            return {
              id: workout.id,
              name: workout.name,
              stages: workout.stages.map(function(stage){
                return {
                  name: stage.name,
                  repeats: sanitizePositiveInt(stage.repeats, 1, { min: 1 }),
                  minutes: sanitizePositiveInt(stage.minutes, 0, { min: 0 }),
                  seconds: sanitizePositiveInt(stage.seconds, 0, { min: 0, max: 59 }),
                  bpmMin: stage.bpmMin == null || stage.bpmMin === "" ? null : Number(stage.bpmMin),
                  bpmMax: stage.bpmMax == null || stage.bpmMax === "" ? null : Number(stage.bpmMax),
                  type: stage.type || "custom",
                  split: Boolean(stage.split),
                  secondaryName: stage.secondaryName || "",
                  secondaryType: stage.secondaryType || "rest",
                  secondaryMinutes: sanitizePositiveInt(stage.secondaryMinutes, 0, { min: 0 }),
                  secondarySeconds: sanitizePositiveInt(stage.secondarySeconds, 0, { min: 0, max: 59 }),
                  secondaryBpmMin: stage.secondaryBpmMin == null || stage.secondaryBpmMin === "" ? null : Number(stage.secondaryBpmMin),
                  secondaryBpmMax: stage.secondaryBpmMax == null || stage.secondaryBpmMax === "" ? null : Number(stage.secondaryBpmMax)
                };
              }),
              drafts: workout.drafts ? workout.drafts.map(function(stage){
                return {
                  name: stage.name,
                  repeats: sanitizePositiveInt(stage.repeats, 1, { min: 1 }),
                  minutes: sanitizePositiveInt(stage.minutes, 0, { min: 0 }),
                  seconds: sanitizePositiveInt(stage.seconds, 0, { min: 0, max: 59 }),
                  bpmMin: stage.bpmMin == null || stage.bpmMin === "" ? null : Number(stage.bpmMin),
                  bpmMax: stage.bpmMax == null || stage.bpmMax === "" ? null : Number(stage.bpmMax),
                  type: stage.type || "custom",
                  split: Boolean(stage.split),
                  secondaryName: stage.secondaryName || "",
                  secondaryType: stage.secondaryType || "rest",
                  secondaryMinutes: sanitizePositiveInt(stage.secondaryMinutes, 0, { min: 0 }),
                  secondarySeconds: sanitizePositiveInt(stage.secondarySeconds, 0, { min: 0, max: 59 }),
                  secondaryBpmMin: stage.secondaryBpmMin == null || stage.secondaryBpmMin === "" ? null : Number(stage.secondaryBpmMin),
                  secondaryBpmMax: stage.secondaryBpmMax == null || stage.secondaryBpmMax === "" ? null : Number(stage.secondaryBpmMax)
                };
              }) : null
            };
          }),
          currentId: currentWorkout ? currentWorkout.id : null,
          activeId: activeWorkout ? activeWorkout.id : null
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (err) {
        console.warn(t("No se pudo guardar la configuración", "Unable to save configuration"), err);
      }
    }

    function loadPersistedWorkouts() {
      if (!isStorageAvailable()) return null;
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object" || !Array.isArray(parsed.workouts)) {
          return null;
        }
        const restoredWorkouts = [];
        parsed.workouts.forEach(function(entry){
          if (!entry || typeof entry !== "object" || !Array.isArray(entry.stages)) return;
          restoredWorkouts.push({
            id: entry.id || `workout-${Date.now()}-${Math.random().toString(16).slice(2)}`,
            name: entry.name || fallbackWorkoutName,
            stages: entry.stages.map(function(stage){
              return createStage({
                name: stage.name,
                repeats: stage.repeats,
                minutes: stage.minutes,
                seconds: stage.seconds,
                bpmMin: stage.bpmMin == null ? "" : stage.bpmMin,
                bpmMax: stage.bpmMax == null ? "" : stage.bpmMax,
                type: stage.type,
                split: stage.split,
                secondaryName: stage.secondaryName,
                secondaryType: stage.secondaryType,
                secondaryMinutes: stage.secondaryMinutes,
                secondarySeconds: stage.secondarySeconds,
                secondaryBpmMin: stage.secondaryBpmMin == null ? "" : stage.secondaryBpmMin,
                secondaryBpmMax: stage.secondaryBpmMax == null ? "" : stage.secondaryBpmMax
              });
            }),
            drafts: Array.isArray(entry.drafts) ? entry.drafts.map(function(stage){
              return createStage({
                name: stage.name,
                repeats: stage.repeats,
                minutes: stage.minutes,
                seconds: stage.seconds,
                bpmMin: stage.bpmMin == null ? "" : stage.bpmMin,
                bpmMax: stage.bpmMax == null ? "" : stage.bpmMax,
                type: stage.type,
                split: stage.split,
                secondaryName: stage.secondaryName,
                secondaryType: stage.secondaryType,
                secondaryMinutes: stage.secondaryMinutes,
                secondarySeconds: stage.secondarySeconds,
                secondaryBpmMin: stage.secondaryBpmMin == null ? "" : stage.secondaryBpmMin,
                secondaryBpmMax: stage.secondaryBpmMax == null ? "" : stage.secondaryBpmMax
              });
            }) : null
          });
        });
        return {
          workouts: restoredWorkouts,
          currentId: parsed.currentId || null,
          activeId: parsed.activeId || null
        };
      } catch (err) {
        console.warn(t("No se pudo cargar la configuración", "Unable to load workout configuration"), err);
        return null;
      }
    }

    function bootstrapWorkouts() {
      const stored = loadPersistedWorkouts();
      if (stored && Array.isArray(stored.workouts) && stored.workouts.length) {
        workouts = stored.workouts.map(cloneWorkout);
        const selected = stored.currentId ? workouts.find(function(item){
          return item.id === stored.currentId;
        }) : null;
        const active = stored.activeId ? workouts.find(function(item){
          return item.id === stored.activeId;
        }) : null;
        currentWorkout = selected || active || workouts[0];
        activeWorkout = active || currentWorkout;
      } else {
        const defaultWorkout = {
          id: "default-workout",
          name: t("Sesión base", "Base session"),
          stages: defaultStages.map(cloneStage),
          drafts: defaultStages.map(cloneStage)
        };
        workouts = [defaultWorkout];
        currentWorkout = defaultWorkout;
        activeWorkout = defaultWorkout;
      }

      workoutIdCounter = workouts.length;

      const draftSource = currentWorkout && currentWorkout.drafts && currentWorkout.drafts.length
        ? currentWorkout.drafts
        : (currentWorkout ? currentWorkout.stages : defaultStages);

      stageDrafts = draftSource.map(cloneStage);
      activeStages = (activeWorkout ? activeWorkout.stages : defaultStages).map(cloneStage);
      if (!currentWorkout) {
        currentWorkout = workouts[0];
      }
      if (!activeWorkout) {
        activeWorkout = currentWorkout;
      }
    }

    const userLocale = (typeof navigator !== "undefined" && navigator.languages && navigator.languages.length)
      ? navigator.languages[0]
      : (typeof navigator !== "undefined" ? navigator.language : "es");
    const isSpanish = /^es([-_]|$)/i.test(userLocale || "");
    document.documentElement.lang = isSpanish ? "es" : "en";
    function t(esText, enText) {
      return isSpanish ? esText : enText;
    }

    const defaultStages = [
      createStage({ name: t("Calentamiento", "Warm up"), repeats: 1, minutes: 4, seconds: 0, bpmMin: 110, bpmMax: 130, type: "warmup" }),
      createStage({ name: t("Intervalo rápido", "Hard interval"), repeats: 5, minutes: 2, seconds: 0, bpmMin: 155, bpmMax: 170, type: "fast" }),
      createStage({ name: t("Recuperación andando", "Walk recovery"), repeats: 5, minutes: 2, seconds: 0, bpmMin: 100, bpmMax: 125, type: "rest" }),
      createStage({ name: t("Enfriamiento", "Cool down"), repeats: 1, minutes: 4, seconds: 0, bpmMin: 110, bpmMax: 130, type: "cooldown" })
    ];

    let workouts = [];
    let currentWorkout = null;
    let activeWorkout = null;
    let stageDrafts = [];
    let activeStages = [];

    const workoutPlan = [];

    // Estado
    let currentSegment = 0;        // índice en workoutPlan
    let remaining = 0;             // segundos restantes del segmento actual
    let isRunning = false;
    let started = false;
    let timerId = null;
    let audioCtx = null;
    let wakeLockSentinel = null;
    let sessionPickerReturnFocus = null;
    let deferredInstallPrompt = null;

    // DOM refs
    const sessionTitleEl = document.getElementById("sessionTitle");
    const timeDisplayEl = document.getElementById("timeDisplay");
    const currentPhaseLabelEl = document.getElementById("currentPhaseLabel");
    const bpmTargetEl = document.getElementById("bpmTarget");
    const subStatusEl = document.getElementById("subStatus");
    const intervalCountEl = document.getElementById("intervalCount");
    const progressBarEl = document.getElementById("progressBar");
    const startPauseBtnEl = document.getElementById("startPauseBtn");
    const resetBtnEl = document.getElementById("resetBtn");
    const skipBtnEl = document.getElementById("skipBtn");
    const skip10BtnEl = document.getElementById("skip10Btn");
    const fullscreenToggleBtnEl = document.getElementById("fullscreenToggleBtn");
    const installBtnEl = document.getElementById("installBtn");
    const configStagesContainer = document.getElementById("configStagesContainer");
    const configAddStageBtn = document.getElementById("configAddStageBtn");
    const configApplyBtn = document.getElementById("configApplyBtn");
    const configExportBtn = document.getElementById("configExportBtn");
    const configImportBtn = document.getElementById("configImportBtn");
    const configImportInput = document.getElementById("configImportInput");
    const configFeedbackEl = document.getElementById("configFeedback");
    const planListEl = document.getElementById("planList");
    const planTotalDurationEl = document.getElementById("planTotalDuration");
    const planWorkoutNameEl = document.getElementById("planWorkoutName");
    const configOpenBtn = document.getElementById("configOpenBtn");
    const configCloseBtn = document.getElementById("configCloseBtn");
    const configScreenEl = document.getElementById("configScreen");
    const workoutSelectEl = document.getElementById("workoutSelect");
    const workoutNameInputEl = document.getElementById("workoutNameInput");
    const workoutAddBtn = document.getElementById("workoutAddBtn");
    const workoutDuplicateBtn = document.getElementById("workoutDuplicateBtn");
    const workoutDeleteBtn = document.getElementById("workoutDeleteBtn");
    const sessionPickerEl = document.getElementById("sessionPicker");
    const sessionPickerListEl = document.getElementById("sessionPickerList");
    const sessionPickerCloseBtn = document.getElementById("sessionPickerCloseBtn");

    const stageTypeOptions = [
      { value: "warmup", label: t("Calentamiento", "Warm up") },
      { value: "fast", label: t("Trabajo intenso", "Hard effort") },
      { value: "rest", label: t("Recuperación", "Recovery") },
      { value: "cooldown", label: t("Enfriamiento", "Cool down") },
      { value: "custom", label: t("Personalizado", "Custom") }
    ];

    const fallbackWorkoutName = t("Entrenamiento", "Workout");
    const duplicateSuffix = t("copia", "copy");
    const typeHintLabels = {
      warmup: t("Calentamiento suave", "Gentle warm up"),
      fast: t("Ritmo alto", "High effort"),
      rest: t("Recupera andando", "Walk recovery"),
      cooldown: t("Baja pulsaciones", "Cool down")
    };

    function applyStaticTranslations() {
      if (typeof document !== "undefined") {
        document.title = t("Intervalos de carrera", "Running intervals");
      }

      if (sessionTitleEl) {
        sessionTitleEl.textContent = activeWorkout && activeWorkout.name ? activeWorkout.name : t("Sesión de intervalos", "Interval session");
      }
      if (currentPhaseLabelEl) currentPhaseLabelEl.textContent = t("Listo", "Ready");
      if (subStatusEl) subStatusEl.textContent = t("Pulsa Iniciar", "Press Start");
      if (startPauseBtnEl) startPauseBtnEl.textContent = t("Iniciar", "Start");
      if (skip10BtnEl) skip10BtnEl.textContent = t("Saltar 10s", "Skip 10s");
      if (skipBtnEl) skipBtnEl.textContent = t("Saltar fase", "Skip phase");
      if (fullscreenToggleBtnEl) fullscreenToggleBtnEl.textContent = t("Pantalla completa", "Enter fullscreen");
      if (configOpenBtn) configOpenBtn.textContent = t("Configurar", "Configure");
      if (resetBtnEl) resetBtnEl.textContent = t("Reiniciar", "Reset");

      const hrmPanelTitleEl = document.getElementById("hrmPanelTitle");
      if (hrmPanelTitleEl) hrmPanelTitleEl.textContent = t("Sesión HR", "HR session");
      const hrmChartEl = document.getElementById("hrmChart");
      if (hrmChartEl) hrmChartEl.setAttribute("aria-label", t("Historial de ritmo cardíaco", "Heart rate history"));
      const hrmToggleButton = document.getElementById("hrmToggleBtn");
      if (hrmToggleButton) hrmToggleButton.textContent = t("Conectar banda", "Connect band");
      const hrmStatusNode = document.getElementById("hrmStatus");
      if (hrmStatusNode) hrmStatusNode.textContent = t("Listo para conectar.", "Ready to connect.");
      const bottomControlsEl = document.querySelector(".bottom-controls");
      if (bottomControlsEl) bottomControlsEl.setAttribute("aria-label", t("Controles de sesión", "Session controls"));

      const sessionPickerTitleEl = document.getElementById("sessionPickerTitle");
      if (sessionPickerTitleEl) sessionPickerTitleEl.textContent = t("Seleccionar sesión", "Select session");
      if (sessionPickerCloseBtn) sessionPickerCloseBtn.textContent = t("Cerrar", "Close");
      if (sessionPickerListEl) sessionPickerListEl.setAttribute("aria-label", t("Sesiones disponibles", "Available sessions"));

      const configScreenTitleEl = document.getElementById("configScreenTitle");
      if (configScreenTitleEl) configScreenTitleEl.textContent = t("Configurar sesión", "Configure session");
      if (configExportBtn) configExportBtn.textContent = t("Descargar", "Download");
      if (configImportBtn) configImportBtn.textContent = t("Subir", "Upload");
      if (configApplyBtn) configApplyBtn.textContent = t("Guardar", "Save");
      if (configCloseBtn) configCloseBtn.textContent = t("Cerrar", "Close");

      const workoutPickerTitleEl = document.getElementById("workoutPickerTitle");
      if (workoutPickerTitleEl) workoutPickerTitleEl.textContent = t("Entrenamiento", "Workout");
      if (workoutAddBtn) workoutAddBtn.textContent = t("Nuevo", "New");
      if (workoutDuplicateBtn) workoutDuplicateBtn.textContent = t("Duplicar", "Duplicate");
      if (workoutDeleteBtn) workoutDeleteBtn.textContent = t("Eliminar", "Delete");
      const workoutNameLabel = document.querySelector('label[for="workoutNameInput"]');
      if (workoutNameLabel) workoutNameLabel.textContent = t("Nombre del entrenamiento", "Workout name");
      if (workoutNameInputEl) workoutNameInputEl.placeholder = t("Ej. Series tempo", "e.g. Tempo sets");

      const configTitleEl = document.getElementById("configTitle");
      if (configTitleEl) configTitleEl.textContent = t("Intervalos", "Intervals");
      if (configAddStageBtn) configAddStageBtn.textContent = t("Añadir etapa", "Add stage");

      const planTitleEl = document.getElementById("planTitle");
      if (planTitleEl) planTitleEl.textContent = t("Resumen de etapas", "Stage summary");
      if (installBtnEl) installBtnEl.textContent = t("Instalar app", "Install app");
    }

    // Utils
    function fmtTime(totalSec) {
      const safe = Math.max(0, Math.floor(totalSec));
      const m = Math.floor(safe / 60);
      const s = safe % 60;
      const mm = m.toString().padStart(2,"0");
      const ss = s.toString().padStart(2,"0");
      return mm + ":" + ss;
    }

    function secondsFromStage(stage) {
      const minutes = sanitizePositiveInt(stage.minutes, 0, { min: 0 });
      const seconds = sanitizePositiveInt(stage.seconds, 0, { min: 0, max: 59 });
      let total = minutes * 60 + seconds;
      if (stage.split) {
        const secondaryMinutes = sanitizePositiveInt(stage.secondaryMinutes, 0, { min: 0 });
        const secondarySeconds = sanitizePositiveInt(stage.secondarySeconds, 0, { min: 0, max: 59 });
        total += secondaryMinutes * 60 + secondarySeconds;
      }
      return total;
    }

    function totalDurationFromStages(stages) {
      let total = 0;
      for (const stage of stages) {
        const duration = secondsFromStage(stage);
        const repeats = sanitizePositiveInt(stage.repeats, 1, { min: 1 });
        total += duration * repeats;
      }
      return total;
    }

    function serializeStageForConfig(stage) {
      return {
        name: stage.name || "",
        repeats: sanitizePositiveInt(stage.repeats, 1, { min: 1 }),
        minutes: sanitizePositiveInt(stage.minutes, 0, { min: 0 }),
        seconds: sanitizePositiveInt(stage.seconds, 0, { min: 0, max: 59 }),
        bpmMin: stage.bpmMin == null || stage.bpmMin === "" ? null : Number(stage.bpmMin),
        bpmMax: stage.bpmMax == null || stage.bpmMax === "" ? null : Number(stage.bpmMax),
        type: stage.type || "custom",
        split: Boolean(stage.split),
        secondaryName: stage.secondaryName || "",
        secondaryType: stage.secondaryType || "rest",
        secondaryMinutes: sanitizePositiveInt(stage.secondaryMinutes, 0, { min: 0 }),
        secondarySeconds: sanitizePositiveInt(stage.secondarySeconds, 0, { min: 0, max: 59 }),
        secondaryBpmMin: stage.secondaryBpmMin == null || stage.secondaryBpmMin === "" ? null : Number(stage.secondaryBpmMin),
        secondaryBpmMax: stage.secondaryBpmMax == null || stage.secondaryBpmMax === "" ? null : Number(stage.secondaryBpmMax)
      };
    }

    function formatBpmRange(min, max) {
      const hasMin = min != null && min !== "" && !Number.isNaN(min);
      const hasMax = max != null && max !== "" && !Number.isNaN(max);
      if (hasMin && hasMax) {
        return `${min} - ${max} bpm`;
      }
      if (hasMin) {
        return `≥ ${min} bpm`;
      }
      if (hasMax) {
        return `≤ ${max} bpm`;
      }
      return "-- bpm";
    }

    function setConfigFeedback(kind, message) {
      if (!configFeedbackEl) return;
      configFeedbackEl.textContent = message || "";
      configFeedbackEl.classList.remove("error", "success");
      if (!message) return;
      if (kind === "error") {
        configFeedbackEl.classList.add("error");
      } else if (kind === "success") {
        configFeedbackEl.classList.add("success");
      }
    }

    function openConfigScreen() {
      if (!configScreenEl) return;
      renderWorkoutSelector();
      updateWorkoutNameInputField();
      configScreenEl.hidden = false;
      configScreenEl.setAttribute("aria-hidden", "false");
      document.body.classList.add("modal-open");
      setConfigFeedback(null, "");
      configScreenEl.focus({ preventScroll: true });
    }

    function closeConfigScreen(options) {
      if (!configScreenEl) return;
      const settings = options || {};
      configScreenEl.hidden = true;
      configScreenEl.setAttribute("aria-hidden", "true");
      document.body.classList.remove("modal-open");
      setConfigFeedback(null, "");
      if (settings.restoreFocus !== false && configOpenBtn) {
        configOpenBtn.focus({ preventScroll: true });
      }
    }

    function createControlField(stage, fieldConfig) {
      const wrapper = document.createElement("div");
      wrapper.className = "stage-field";

      const labelEl = document.createElement("label");
      labelEl.setAttribute("for", `${stage.id}-${fieldConfig.field}`);
      labelEl.textContent = fieldConfig.label;
      wrapper.appendChild(labelEl);

      let control;
      if (fieldConfig.type === "select") {
        control = document.createElement("select");
        control.dataset.field = fieldConfig.field;
        fieldConfig.options.forEach(function(option){
          const opt = document.createElement("option");
          opt.value = option.value;
          opt.textContent = option.label;
          control.appendChild(opt);
        });
        control.value = stage[fieldConfig.field];
      } else {
        control = document.createElement("input");
        control.type = fieldConfig.inputType || "text";
        if (fieldConfig.min != null) control.min = fieldConfig.min;
        if (fieldConfig.max != null) control.max = fieldConfig.max;
        if (fieldConfig.step != null) control.step = fieldConfig.step;
        if (fieldConfig.placeholder) control.placeholder = fieldConfig.placeholder;
        const currentValue = stage[fieldConfig.field];
        control.value = currentValue === "" ? "" : currentValue;
      }

      control.id = `${stage.id}-${fieldConfig.field}`;
      control.dataset.stageId = stage.id;
      control.dataset.field = fieldConfig.field;
      wrapper.appendChild(control);

      return wrapper;
    }

    function renderStagesForm() {
      if (!configStagesContainer) return;
      configStagesContainer.innerHTML = "";

      if (stageDrafts.length === 0) {
        const emptyState = document.createElement("div");
        emptyState.className = "config-empty";
        emptyState.textContent = t("Añade etapas para generar el plan.", "Add stages to build the plan.");
        configStagesContainer.appendChild(emptyState);
        return;
      }

      stageDrafts.forEach(function(stage, index){
        const card = document.createElement("div");
        card.className = "stage-card";
        card.dataset.stageId = stage.id;

        const rowOne = document.createElement("div");
        rowOne.className = "stage-row";
        rowOne.appendChild(createControlField(stage, { field: "name", label: t("Nombre", "Name"), placeholder: t("Ej. Calentamiento", "e.g. Warm up") }));
        rowOne.appendChild(createControlField(stage, { field: "type", label: t("Tipo", "Type"), type: "select", options: stageTypeOptions }));

        const rowTwo = document.createElement("div");
        rowTwo.className = "stage-row";
        rowTwo.appendChild(createControlField(stage, { field: "repeats", label: t("Repeticiones", "Repeats"), inputType: "number", min: "1" }));
        rowTwo.appendChild(createControlField(stage, { field: "minutes", label: t("Duración (min)", "Duration (min)"), inputType: "number", min: "0" }));
        rowTwo.appendChild(createControlField(stage, { field: "seconds", label: t("Duración (s)", "Duration (s)"), inputType: "number", min: "0", max: "59" }));

        const rowThree = document.createElement("div");
        rowThree.className = "stage-row";
        rowThree.appendChild(createControlField(stage, { field: "bpmMin", label: t("BPM mínimo", "Min BPM"), inputType: "number", min: "0" }));
        rowThree.appendChild(createControlField(stage, { field: "bpmMax", label: t("BPM máximo", "Max BPM"), inputType: "number", min: "0" }));

        const splitToggle = document.createElement("label");
        splitToggle.className = "stage-split-toggle";
        splitToggle.setAttribute("for", `${stage.id}-split`);
        const splitCheckbox = document.createElement("input");
        splitCheckbox.type = "checkbox";
        splitCheckbox.id = `${stage.id}-split`;
        splitCheckbox.dataset.stageId = stage.id;
        splitCheckbox.dataset.field = "split";
        splitCheckbox.checked = Boolean(stage.split);
        const splitText = document.createElement("span");
        splitText.textContent = t("Añadir segunda subfase (ej. descanso)", "Add a second sub-phase (e.g. rest)");
        splitToggle.appendChild(splitCheckbox);
        splitToggle.appendChild(splitText);

        let secondaryBlock = null;
        if (stage.split) {
          secondaryBlock = document.createElement("div");
          secondaryBlock.className = "stage-subphase";

          const secondaryHeading = document.createElement("div");
          secondaryHeading.className = "stage-subphase-heading";
          secondaryHeading.textContent = t("Subfase 2", "Sub-phase 2");
          secondaryBlock.appendChild(secondaryHeading);

          const secondaryRowOne = document.createElement("div");
          secondaryRowOne.className = "stage-row";
          secondaryRowOne.appendChild(createControlField(stage, { field: "secondaryName", label: t("Nombre", "Name"), placeholder: t("Ej. Recuperación", "e.g. Recovery") }));
          secondaryRowOne.appendChild(createControlField(stage, { field: "secondaryType", label: t("Tipo", "Type"), type: "select", options: stageTypeOptions }));

          const secondaryRowTwo = document.createElement("div");
          secondaryRowTwo.className = "stage-row";
          secondaryRowTwo.appendChild(createControlField(stage, { field: "secondaryMinutes", label: t("Duración (min)", "Duration (min)"), inputType: "number", min: "0" }));
          secondaryRowTwo.appendChild(createControlField(stage, { field: "secondarySeconds", label: t("Duración (s)", "Duration (s)"), inputType: "number", min: "0", max: "59" }));

          const secondaryRowThree = document.createElement("div");
          secondaryRowThree.className = "stage-row";
          secondaryRowThree.appendChild(createControlField(stage, { field: "secondaryBpmMin", label: t("BPM mínimo", "Min BPM"), inputType: "number", min: "0" }));
          secondaryRowThree.appendChild(createControlField(stage, { field: "secondaryBpmMax", label: t("BPM máximo", "Max BPM"), inputType: "number", min: "0" }));

          secondaryBlock.appendChild(secondaryRowOne);
          secondaryBlock.appendChild(secondaryRowTwo);
          secondaryBlock.appendChild(secondaryRowThree);
        }

        const actions = document.createElement("div");
        actions.className = "stage-actions";

        const moveUpBtn = document.createElement("button");
        moveUpBtn.type = "button";
        moveUpBtn.className = "stage-move-btn";
        moveUpBtn.dataset.stageId = stage.id;
        moveUpBtn.dataset.direction = "up";
        moveUpBtn.textContent = t("Subir", "Move up");
        if (index === 0) {
          moveUpBtn.disabled = true;
        }
        actions.appendChild(moveUpBtn);

        const moveDownBtn = document.createElement("button");
        moveDownBtn.type = "button";
        moveDownBtn.className = "stage-move-btn";
        moveDownBtn.dataset.stageId = stage.id;
        moveDownBtn.dataset.direction = "down";
        moveDownBtn.textContent = t("Bajar", "Move down");
        if (index === stageDrafts.length - 1) {
          moveDownBtn.disabled = true;
        }
        actions.appendChild(moveDownBtn);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "stage-remove-btn";
        removeBtn.dataset.stageId = stage.id;
        removeBtn.textContent = t("Eliminar", "Delete");
        actions.appendChild(removeBtn);

        card.appendChild(rowOne);
        card.appendChild(rowTwo);
        card.appendChild(rowThree);
        card.appendChild(splitToggle);
        if (secondaryBlock) {
          card.appendChild(secondaryBlock);
        }
        card.appendChild(actions);
        configStagesContainer.appendChild(card);
      });
    }

    function renderPlanSummary() {
      if (!planListEl || !planTotalDurationEl) return;

      if (activeStages.length === 0) {
        planListEl.innerHTML = `<div class="config-empty">${t("Aplica una configuración para generar el plan.", "Apply a configuration to generate the plan.")}</div>`;
        planTotalDurationEl.textContent = "";
        if (planWorkoutNameEl) {
          planWorkoutNameEl.textContent = activeWorkout ? activeWorkout.name : "";
        }
        return;
      }

      const fragments = document.createDocumentFragment();
      activeStages.forEach(function(stage, index){
        const item = document.createElement("div");
        item.className = "plan-item";

        const main = document.createElement("div");
        main.className = "plan-item-main";
        const label = document.createElement("div");
        label.className = "plan-item-label";
        label.textContent = stage.name || t(`Etapa ${index + 1}`, `Stage ${index + 1}`);
        const desc = document.createElement("div");
        desc.className = "plan-item-desc";
        const primaryMinutes = sanitizePositiveInt(stage.minutes, 0, { min: 0 });
        const primarySeconds = sanitizePositiveInt(stage.seconds, 0, { min: 0, max: 59 });
        const primaryDuration = primaryMinutes * 60 + primarySeconds;
        const primaryBpmLabel = formatBpmRange(
          stage.bpmMin === "" ? null : stage.bpmMin,
          stage.bpmMax === "" ? null : stage.bpmMax
        );

        if (stage.split) {
          const secondaryMinutes = sanitizePositiveInt(stage.secondaryMinutes, 0, { min: 0 });
          const secondarySeconds = sanitizePositiveInt(stage.secondarySeconds, 0, { min: 0, max: 59 });
          const secondaryDuration = secondaryMinutes * 60 + secondarySeconds;
          const secondaryBpmLabel = formatBpmRange(
            stage.secondaryBpmMin === "" ? null : stage.secondaryBpmMin,
            stage.secondaryBpmMax === "" ? null : stage.secondaryBpmMax
          );
          const segments = [];
          segments.push(`${fmtTime(primaryDuration)} • ${primaryBpmLabel}`);
          segments.push(`${fmtTime(secondaryDuration)} • ${secondaryBpmLabel}`);
          desc.textContent = segments.join(" + ");
        } else {
          desc.textContent = `${fmtTime(primaryDuration)} • ${primaryBpmLabel}`;
        }
        main.appendChild(label);
        main.appendChild(desc);

        const meta = document.createElement("div");
        meta.className = "plan-item-meta";
        meta.textContent = `${sanitizePositiveInt(stage.repeats, 1, { min: 1 })}×`;

        item.appendChild(main);
        item.appendChild(meta);
        fragments.appendChild(item);
      });

      planListEl.innerHTML = "";
      planListEl.appendChild(fragments);

      const totalSeconds = totalDurationFromStages(activeStages);
      planTotalDurationEl.textContent = totalSeconds > 0 ? `${t("Total", "Total")} ${fmtTime(totalSeconds)}` : "";
      if (planWorkoutNameEl) {
        planWorkoutNameEl.textContent = activeWorkout ? activeWorkout.name : "";
      }
    }

    function renderSessionPickerList() {
      if (!sessionPickerListEl) return;
      sessionPickerListEl.innerHTML = "";
      if (!workouts.length) return;

      const fragment = document.createDocumentFragment();
      workouts.forEach(function(workout){
        const button = document.createElement("button");
        button.type = "button";
        button.className = "session-picker-item";
        button.dataset.workoutId = workout.id;
        button.setAttribute("role", "option");
        const nameSpan = document.createElement("span");
        nameSpan.className = "session-picker-name";
        nameSpan.textContent = workout.name || t("Entrenamiento", "Workout");
        button.appendChild(nameSpan);

        const totalSeconds = totalDurationFromStages(workout.stages || []);
        const meta = document.createElement("span");
        meta.className = "session-picker-meta";
        meta.textContent = totalSeconds > 0 ? `${t("Total", "Total")} ${fmtTime(totalSeconds)}` : t("Sin duración", "No duration");
        button.appendChild(meta);

        if (activeWorkout && activeWorkout.id === workout.id) {
          button.classList.add("active");
          button.setAttribute("aria-selected", "true");
        } else {
          button.setAttribute("aria-selected", "false");
        }

        fragment.appendChild(button);
      });

      sessionPickerListEl.appendChild(fragment);
    }

    function serializeWorkoutForConfig(workout) {
      return {
        name: workout.name || t("Entrenamiento", "Workout"),
        stages: workout.stages.map(serializeStageForConfig)
      };
    }

    function exportConfigToJson() {
      try {
        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          workouts: workouts.map(serializeWorkoutForConfig),
          activeName: activeWorkout ? activeWorkout.name : null,
          currentName: currentWorkout ? currentWorkout.name : null
        };
        const json = JSON.stringify(payload, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement("a");
        const timestamp = new Date().toISOString().replace(/[:]/g, "-");
        anchor.href = url;
        const filePrefix = t("config-sesiones", "config-sessions");
        anchor.download = `${filePrefix}-${timestamp}.json`;
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        setTimeout(function(){ URL.revokeObjectURL(url); }, 1500);
        setConfigFeedback("success", payload.workouts.length ? t("Sesiones descargadas.", "Sessions exported.") : t("No había sesiones para exportar.", "There were no sessions to export."));
      } catch (err) {
        console.error("Export error", err);
        setConfigFeedback("error", t("No se pudo descargar la configuración.", "Unable to export the configuration."));
      }
    }

    function importConfigFromData(data) {
      if (!data || typeof data !== "object") {
        throw new Error(t("Formato inválido", "Invalid format"));
      }
      let rawWorkouts = null;
      if (Array.isArray(data.workouts)) {
        rawWorkouts = data.workouts;
      } else if (Array.isArray(data)) {
        rawWorkouts = data;
      }
      if (!rawWorkouts) {
        throw new Error(t("No hay sesiones en el archivo", "No sessions in file"));
      }

      const rebuiltWorkouts = rawWorkouts.map(function(entry, index){
        const name = entry && typeof entry.name === "string" && entry.name.trim() ? entry.name.trim() : t(`Entrenamiento ${index + 1}`, `Workout ${index + 1}`);
        const rawStages = Array.isArray(entry.stages) ? entry.stages : [];
        const stageObjects = rawStages.map(function(stage){
          return createStage({
            name: stage && stage.name,
            repeats: stage && stage.repeats,
            minutes: stage && stage.minutes,
            seconds: stage && stage.seconds,
            bpmMin: stage && (stage.bpmMin == null ? "" : stage.bpmMin),
            bpmMax: stage && (stage.bpmMax == null ? "" : stage.bpmMax),
            type: stage && stage.type,
            split: stage && stage.split,
            secondaryName: stage && stage.secondaryName,
            secondaryType: stage && stage.secondaryType,
            secondaryMinutes: stage && stage.secondaryMinutes,
            secondarySeconds: stage && stage.secondarySeconds,
            secondaryBpmMin: stage && (stage.secondaryBpmMin == null ? "" : stage.secondaryBpmMin),
            secondaryBpmMax: stage && (stage.secondaryBpmMax == null ? "" : stage.secondaryBpmMax)
          });
        });
        return {
          id: generateWorkoutId(),
          name,
          stages: stageObjects.map(cloneStage),
          drafts: stageObjects.map(cloneStage)
        };
      });

      workouts = rebuiltWorkouts;

      const desiredCurrentName = typeof data.currentName === "string" ? data.currentName : null;
      const desiredActiveName = typeof data.activeName === "string" ? data.activeName : null;

      currentWorkout = desiredCurrentName ? workouts.find(function(item){ return item.name === desiredCurrentName; }) : null;
      activeWorkout = desiredActiveName ? workouts.find(function(item){ return item.name === desiredActiveName; }) : null;

      if (!currentWorkout) {
        currentWorkout = workouts.length ? workouts[0] : null;
      }
      if (!activeWorkout) {
        activeWorkout = currentWorkout;
      }

      stageDrafts = currentWorkout ? (currentWorkout.drafts && currentWorkout.drafts.length ? currentWorkout.drafts.map(cloneStage) : currentWorkout.stages.map(cloneStage)) : [];
      activeStages = activeWorkout ? activeWorkout.stages.map(cloneStage) : [];

      renderStagesForm();
      renderWorkoutSelector();
      updateWorkoutNameInputField();
      rebuildWorkoutPlan();
      renderPlanSummary();
      updateUI();
      snapshotWorkoutDraft();
      persistWorkouts();
      setConfigFeedback("success", t("Sesiones importadas. Revisa y guarda si es necesario.", "Sessions imported. Review and save if needed."));
    }

    function handleConfigImportFile(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const text = event.target && typeof event.target.result === "string" ? event.target.result : "";
          if (!text) {
            throw new Error(t("Archivo vacío", "Empty file"));
          }
          const parsed = JSON.parse(text);
          importConfigFromData(parsed);
        } catch (err) {
          console.error("Import error", err);
          setConfigFeedback("error", t("El archivo no contiene una configuración válida.", "The file does not contain a valid configuration."));
        } finally {
          if (configImportInput) {
            configImportInput.value = "";
          }
        }
      };
      reader.onerror = function(){
        console.error(t("Lectura de archivo fallida", "File read failed"), reader.error);
        setConfigFeedback("error", t("No se pudo leer el archivo seleccionado.", "Unable to read the selected file."));
        if (configImportInput) {
          configImportInput.value = "";
        }
      };
      reader.readAsText(file);
    }

    function openSessionPicker() {
      if (!sessionPickerEl) return;
      if (sessionPickerEl.hidden === false) return;
      renderSessionPickerList();
      sessionPickerReturnFocus = document.activeElement;
      sessionPickerEl.hidden = false;
      sessionPickerEl.setAttribute("aria-hidden", "false");
      if (sessionTitleEl) {
        sessionTitleEl.setAttribute("aria-expanded", "true");
      }
      document.body.classList.add("modal-open");
      const firstItem = sessionPickerListEl ? sessionPickerListEl.querySelector(".session-picker-item") : null;
      if (firstItem) {
        firstItem.focus({ preventScroll: true });
      } else {
        sessionPickerEl.focus({ preventScroll: true });
      }
    }

    function closeSessionPicker(options) {
      if (!sessionPickerEl) return;
      if (sessionPickerEl.hidden === true) return;
      const settings = options || {};
      sessionPickerEl.hidden = true;
      sessionPickerEl.setAttribute("aria-hidden", "true");
      if (!configScreenEl || configScreenEl.hidden !== false) {
        document.body.classList.remove("modal-open");
      }
      if (sessionTitleEl) {
        sessionTitleEl.setAttribute("aria-expanded", "false");
      }
      if (settings.restoreFocus !== false) {
        const target = sessionPickerReturnFocus && typeof sessionPickerReturnFocus.focus === "function"
          ? sessionPickerReturnFocus
          : sessionTitleEl;
        if (target && typeof target.focus === "function") {
          target.focus({ preventScroll: true });
        }
      }
      sessionPickerReturnFocus = null;
    }

    function activateWorkout(workoutId) {
      if (!workoutId) return false;
      if (currentWorkout && currentWorkout.id === workoutId && activeWorkout && activeWorkout.id === workoutId) {
        return true;
      }

      const target = workouts.find(function(workout){
        return workout.id === workoutId;
      });
      if (!target) {
        return false;
      }

      if (currentWorkout && currentWorkout.id !== workoutId) {
        currentWorkout.drafts = stageDrafts.map(cloneStage);
      }

      currentWorkout = target;
      const draftSource = target.drafts && target.drafts.length ? target.drafts : target.stages;
      stageDrafts = draftSource.map(cloneStage);
      renderStagesForm();

      activeWorkout = target;
      activeStages = target.stages.map(cloneStage);
      rebuildWorkoutPlan();
      stopTimer();
      currentSegment = 0;
      started = false;
      if (workoutPlan.length > 0) {
        remaining = workoutPlan[0].durationSec;
        subStatusEl.textContent = t("Pulsa Iniciar", "Press Start");
        intervalCountEl.textContent = "";
        progressBarEl.style.width = "0%";
      } else {
        remaining = 0;
        subStatusEl.textContent = t("Configura tus etapas y aplica.", "Configure your stages and apply.");
        intervalCountEl.textContent = "";
        progressBarEl.style.width = "0%";
      }

      renderPlanSummary();
      updateUI();
      renderWorkoutSelector();
      updateWorkoutNameInputField();
      renderSessionPickerList();
      persistWorkouts();
      updateHrmRangeFeedback(null);
      setConfigFeedback(null, "");
      return true;
    }

    function renderWorkoutSelector() {
      if (!workoutSelectEl) return;
      workoutSelectEl.innerHTML = "";
      workouts.forEach(function(workout){
        const option = document.createElement("option");
        option.value = workout.id;
        option.textContent = workout.name || fallbackWorkoutName;
        workoutSelectEl.appendChild(option);
      });
      if (currentWorkout) {
        workoutSelectEl.value = currentWorkout.id;
      }
      updateWorkoutButtonsState();
      renderSessionPickerList();
    }

    function updateWorkoutNameInputField() {
      if (!workoutNameInputEl) return;
      workoutNameInputEl.value = currentWorkout ? (currentWorkout.name || "") : "";
      workoutNameInputEl.disabled = !currentWorkout;
    }

    function updateWorkoutButtonsState() {
      const moreThanOne = workouts.length > 1;
      if (workoutDeleteBtn) {
        workoutDeleteBtn.disabled = !moreThanOne;
      }
      if (workoutDuplicateBtn) {
        workoutDuplicateBtn.disabled = !currentWorkout;
      }
    }

    function snapshotWorkoutDraft() {
      if (!currentWorkout) return;
      currentWorkout.drafts = stageDrafts.map(cloneStage);
      persistWorkouts();
    }

    function rebuildWorkoutPlan() {
      workoutPlan.length = 0;
      activeStages.forEach(function(stage, stageIndex){
        const repeats = sanitizePositiveInt(stage.repeats, 1, { min: 1 });
        if (repeats <= 0) {
          return;
        }

        const primaryMinutes = sanitizePositiveInt(stage.minutes, 0, { min: 0 });
        const primarySeconds = sanitizePositiveInt(stage.seconds, 0, { min: 0, max: 59 });
        const primaryDurationSec = primaryMinutes * 60 + primarySeconds;
        if (primaryDurationSec <= 0) {
          return;
        }

        const primaryBpmMin = stage.bpmMin === "" ? null : Number(stage.bpmMin);
        const primaryBpmMax = stage.bpmMax === "" ? null : Number(stage.bpmMax);
        const primaryBpmLabel = formatBpmRange(primaryBpmMin, primaryBpmMax);

        const hasSecondary = Boolean(stage.split);
        const secondaryMinutes = sanitizePositiveInt(stage.secondaryMinutes, 0, { min: 0 });
        const secondarySeconds = sanitizePositiveInt(stage.secondarySeconds, 0, { min: 0, max: 59 });
        const secondaryDurationSec = hasSecondary ? (secondaryMinutes * 60 + secondarySeconds) : 0;
        const secondaryBpmMin = stage.secondaryBpmMin === "" ? null : Number(stage.secondaryBpmMin);
        const secondaryBpmMax = stage.secondaryBpmMax === "" ? null : Number(stage.secondaryBpmMax);
        const secondaryBpmLabel = formatBpmRange(secondaryBpmMin, secondaryBpmMax);

        const baseLabel = stage.name || t(`Etapa ${stageIndex + 1}`, `Stage ${stageIndex + 1}`);
        const repeatTotal = repeats > 1 ? repeats : null;

        for (let i = 1; i <= repeats; i++) {
          workoutPlan.push({
            label: baseLabel,
            durationSec: primaryDurationSec,
            type: stage.type || "custom",
            repeatIndex: repeatTotal ? i : null,
            repeatTotal,
            bpmMin: primaryBpmMin,
            bpmMax: primaryBpmMax,
            bpmLabel: primaryBpmLabel,
            subPhase: hasSecondary ? 1 : null
          });

          if (hasSecondary && secondaryDurationSec > 0) {
            const secondaryLabel = (stage.secondaryName && stage.secondaryName.trim())
              ? stage.secondaryName.trim()
              : `${baseLabel} (${t("Subfase 2", "Sub-phase 2")})`;
            workoutPlan.push({
              label: secondaryLabel,
              durationSec: secondaryDurationSec,
              type: stage.secondaryType || "rest",
              repeatIndex: repeatTotal ? i : null,
              repeatTotal,
              bpmMin: secondaryBpmMin,
              bpmMax: secondaryBpmMax,
              bpmLabel: secondaryBpmLabel,
              subPhase: 2
            });
          }
        }
      });
    }

    function validateStages(stages) {
      const errors = [];
      if (!stages.length) {
        errors.push(t("Añade al menos una etapa antes de aplicar.", "Add at least one stage before applying."));
        return errors;
      }
      stages.forEach(function(stage){
        const stageLabel = stage.name || t("Sin nombre", "No name");
        const primaryMinutes = sanitizePositiveInt(stage.minutes, 0, { min: 0 });
        const primarySeconds = sanitizePositiveInt(stage.seconds, 0, { min: 0, max: 59 });
        const primaryDuration = primaryMinutes * 60 + primarySeconds;
        if (primaryDuration <= 0) {
          errors.push(t(
            `La subfase principal de "${stageLabel}" debe durar al menos 1 segundo.`,
            `The main sub-phase of "${stageLabel}" must last at least 1 second.`
          ));
        }
        const repeats = sanitizePositiveInt(stage.repeats, 1, { min: 1 });
        if (repeats <= 0) {
          errors.push(t(
            `La etapa "${stageLabel}" debe repetirse al menos una vez.`,
            `The stage "${stageLabel}" must repeat at least once.`
          ));
        }
        const min = stage.bpmMin === "" ? null : Number(stage.bpmMin);
        const max = stage.bpmMax === "" ? null : Number(stage.bpmMax);
        if (min != null && max != null && min > max) {
          errors.push(t(
            `El mínimo de bpm debe ser menor o igual al máximo en "${stageLabel}".`,
            `The minimum bpm must be less than or equal to the maximum in "${stageLabel}".`
          ));
        }
        if (stage.split) {
          const secondaryMinutes = sanitizePositiveInt(stage.secondaryMinutes, 0, { min: 0 });
          const secondarySeconds = sanitizePositiveInt(stage.secondarySeconds, 0, { min: 0, max: 59 });
          const secondaryDuration = secondaryMinutes * 60 + secondarySeconds;
          if (secondaryDuration <= 0) {
            errors.push(t(
              `La subfase 2 de "${stageLabel}" debe durar al menos 1 segundo.`,
              `The second sub-phase of "${stageLabel}" must last at least 1 second.`
            ));
          }
          const secondaryMin = stage.secondaryBpmMin === "" ? null : Number(stage.secondaryBpmMin);
          const secondaryMax = stage.secondaryBpmMax === "" ? null : Number(stage.secondaryBpmMax);
          if (secondaryMin != null && secondaryMax != null && secondaryMin > secondaryMax) {
            errors.push(t(
              `El mínimo de bpm debe ser menor o igual al máximo en la subfase 2 de "${stageLabel}".`,
              `The minimum bpm must be less than or equal to the maximum in sub-phase 2 of "${stageLabel}".`
            ));
          }
        }
      });
      return errors;
    }

    function applyConfig(options) {
      const settings = options || {};
      const errors = validateStages(stageDrafts);
      if (errors.length) {
        setConfigFeedback("error", errors[0]);
        return false;
      }
      activeStages = stageDrafts.map(cloneStage);
      if (currentWorkout) {
        currentWorkout.stages = activeStages.map(cloneStage);
        currentWorkout.drafts = activeStages.map(cloneStage);
      }
      activeWorkout = currentWorkout;
      rebuildWorkoutPlan();
      stopTimer();
      currentSegment = 0;
      started = false;
      if (workoutPlan.length > 0) {
        remaining = workoutPlan[0].durationSec;
        subStatusEl.textContent = t("Pulsa Iniciar", "Press Start");
        intervalCountEl.textContent = "";
        progressBarEl.style.width = "0%";
      } else {
        remaining = 0;
        subStatusEl.textContent = t("Configura tus etapas y aplica.", "Configure your stages and apply.");
        intervalCountEl.textContent = "";
        progressBarEl.style.width = "0%";
      }
      renderPlanSummary();
      updateUI();
      renderWorkoutSelector();
      updateWorkoutNameInputField();
      persistWorkouts();
      updateHrmRangeFeedback(null);
      if (!settings.silent) {
        setConfigFeedback("success", t("Configuración aplicada.", "Configuration applied."));
      } else {
        setConfigFeedback(null, "");
      }
      return true;
    }

    function handleStageInput(event) {
      const target = event.target;
      if (!target || !target.dataset) return;
      const stageId = target.dataset.stageId;
      const field = target.dataset.field;
      if (!stageId || !field) return;
      const stage = stageDrafts.find(function(item){
        return item.id === stageId;
      });
      if (!stage) return;

      const isCheckbox = target.type === "checkbox";
      const rawValue = isCheckbox ? target.checked : target.value;
      let shouldRerender = false;
      switch (field) {
        case "name":
          stage.name = rawValue;
          break;
        case "type":
          stage.type = rawValue;
          break;
        case "split": {
          const wasSplit = Boolean(stage.split);
          const nextValue = Boolean(rawValue);
          stage.split = nextValue;
          if (nextValue && !wasSplit) {
            if (stage.secondaryName == null) stage.secondaryName = "";
            if (!stage.secondaryType) stage.secondaryType = "rest";
            if (stage.secondaryMinutes === 0) stage.secondaryMinutes = "";
            if (stage.secondarySeconds === 0) stage.secondarySeconds = "";
            if (stage.secondaryBpmMin == null || stage.secondaryBpmMin === 0) stage.secondaryBpmMin = "";
            if (stage.secondaryBpmMax == null || stage.secondaryBpmMax === 0) stage.secondaryBpmMax = "";
          }
          shouldRerender = true;
          break;
        }
        case "repeats": {
          const sanitized = sanitizePositiveInt(rawValue, 1, { min: 1 });
          stage.repeats = sanitized;
          target.value = sanitized;
          break;
        }
        case "minutes": {
          const sanitized = sanitizePositiveInt(rawValue, 0, { min: 0 });
          stage.minutes = sanitized;
          target.value = sanitized;
          break;
        }
        case "seconds": {
          const sanitized = sanitizePositiveInt(rawValue, 0, { min: 0, max: 59 });
          stage.seconds = sanitized;
          target.value = sanitized;
          break;
        }
        case "bpmMin": {
          if (rawValue === "") {
            stage.bpmMin = "";
          } else {
            const sanitized = sanitizePositiveInt(rawValue, 0, { min: 0 });
            stage.bpmMin = sanitized;
            target.value = sanitized;
          }
          break;
        }
        case "bpmMax": {
          if (rawValue === "") {
            stage.bpmMax = "";
          } else {
            const sanitized = sanitizePositiveInt(rawValue, 0, { min: 0 });
            stage.bpmMax = sanitized;
            target.value = sanitized;
          }
          break;
        }
        case "secondaryName":
          stage.secondaryName = rawValue;
          break;
        case "secondaryType":
          stage.secondaryType = rawValue;
          break;
        case "secondaryMinutes": {
          const sanitized = sanitizePositiveInt(rawValue, 0, { min: 0 });
          stage.secondaryMinutes = sanitized;
          target.value = sanitized;
          break;
        }
        case "secondarySeconds": {
          const sanitized = sanitizePositiveInt(rawValue, 0, { min: 0, max: 59 });
          stage.secondarySeconds = sanitized;
          target.value = sanitized;
          break;
        }
        case "secondaryBpmMin": {
          if (rawValue === "") {
            stage.secondaryBpmMin = "";
          } else {
            const sanitized = sanitizePositiveInt(rawValue, 0, { min: 0 });
            stage.secondaryBpmMin = sanitized;
            target.value = sanitized;
          }
          break;
        }
        case "secondaryBpmMax": {
          if (rawValue === "") {
            stage.secondaryBpmMax = "";
          } else {
            const sanitized = sanitizePositiveInt(rawValue, 0, { min: 0 });
            stage.secondaryBpmMax = sanitized;
            target.value = sanitized;
          }
          break;
        }
        default:
          break;
      }

      if (shouldRerender) {
        renderStagesForm();
      }

      setConfigFeedback(null, "");
      snapshotWorkoutDraft();
    }

    function handleStageListClick(event) {
      const removeBtn = event.target.closest && event.target.closest(".stage-remove-btn");
      if (removeBtn) {
        const stageId = removeBtn.dataset.stageId;
        if (!stageId) return;
        const removeIndex = stageDrafts.findIndex(function(stage){
          return stage.id === stageId;
        });
        if (removeIndex === -1) return;
        stageDrafts.splice(removeIndex, 1);
        renderStagesForm();
        setConfigFeedback(null, "");
        snapshotWorkoutDraft();
        return;
      }

      const moveBtn = event.target.closest && event.target.closest(".stage-move-btn");
      if (!moveBtn) return;
      const stageId = moveBtn.dataset.stageId;
      const direction = moveBtn.dataset.direction;
      if (!stageId || !direction) return;
      const currentIndex = stageDrafts.findIndex(function(stage){
        return stage.id === stageId;
      });
      if (currentIndex === -1) return;
      const offset = direction === "up" ? -1 : 1;
      const newIndex = currentIndex + offset;
      if (newIndex < 0 || newIndex >= stageDrafts.length) return;
      const [stage] = stageDrafts.splice(currentIndex, 1);
      stageDrafts.splice(newIndex, 0, stage);
      renderStagesForm();
      setConfigFeedback(null, "");
      snapshotWorkoutDraft();
    }

    function switchToWorkout(workoutId) {
      if (!workoutId) return;
      if (currentWorkout && currentWorkout.id === workoutId) {
        return;
      }
      if (currentWorkout) {
        snapshotWorkoutDraft();
      }
      const target = workouts.find(function(workout){
        return workout.id === workoutId;
      });
      if (!target) return;
      currentWorkout = target;
      const draftSource = target.drafts && target.drafts.length ? target.drafts : target.stages;
      stageDrafts = draftSource.map(cloneStage);
      renderStagesForm();
      renderWorkoutSelector();
      updateWorkoutNameInputField();
      setConfigFeedback("success", t("Entrenamiento seleccionado. Ajusta y aplica para activarlo.", "Workout selected. Tweak and apply to activate it."));
      renderPlanSummary();
      snapshotWorkoutDraft();
      persistWorkouts();
    }

    function handleWorkoutSelectChange(event) {
      const selectedId = event.target.value;
      switchToWorkout(selectedId);
    }

    function handleWorkoutNameInput(event) {
      if (!currentWorkout) return;
      const value = event.target.value;
      currentWorkout.name = value;
      renderWorkoutSelector();
      persistWorkouts();
    }

    function handleWorkoutNameCommit() {
      if (!currentWorkout || !workoutNameInputEl) return;
      const trimmed = workoutNameInputEl.value.trim();
      const nextName = trimmed || fallbackWorkoutName;
      currentWorkout.name = nextName;
      workoutNameInputEl.value = nextName;
      renderWorkoutSelector();
      persistWorkouts();
    }

    function createNewWorkout(options) {
      const settings = options || {};
      const isDuplicate = Boolean(settings.duplicate);
      const sourceStages = Array.isArray(settings.sourceStages)
        ? settings.sourceStages
        : (isDuplicate ? stageDrafts : []);
      const nameBase = settings.name || (isDuplicate ? `${currentWorkout ? currentWorkout.name : fallbackWorkoutName} ${duplicateSuffix}` : null);
      const workout = {
        id: generateWorkoutId(),
        name: generateWorkoutName(nameBase),
        stages: sourceStages.map(cloneStage),
        drafts: sourceStages.map(cloneStage)
      };
      workouts.push(workout);
      switchToWorkout(workout.id);
      renderWorkoutSelector();
      updateWorkoutNameInputField();
      setConfigFeedback("success", settings.duplicate ? t("Entrenamiento duplicado.", "Workout duplicated.") : t("Entrenamiento creado. Añade etapas y guarda.", "Workout created. Add stages and save."));
      persistWorkouts();
    }

    function handleWorkoutAdd() {
      createNewWorkout({});
    }

    function handleWorkoutDuplicate() {
      if (!currentWorkout) return;
      createNewWorkout({
        duplicate: true,
        sourceStages: stageDrafts
      });
    }

    function handleWorkoutDelete() {
      if (workouts.length <= 1 || !currentWorkout) {
        return;
      }
      const deletedId = currentWorkout.id;
      const index = workouts.findIndex(function(workout){
        return workout.id === deletedId;
      });
      if (index === -1) return;
      workouts.splice(index, 1);
      const nextIndex = Math.min(index, workouts.length - 1);
      currentWorkout = workouts[nextIndex];
      const draftSource = currentWorkout.drafts && currentWorkout.drafts.length ? currentWorkout.drafts : currentWorkout.stages;
      stageDrafts = draftSource.map(cloneStage);
      if (activeWorkout && activeWorkout.id === deletedId) {
        activeWorkout = currentWorkout;
        activeStages = currentWorkout.stages.map(cloneStage);
        rebuildWorkoutPlan();
        updateUI();
        updateHrmRangeFeedback(null);
        renderPlanSummary();
      }
      renderStagesForm();
      renderWorkoutSelector();
      updateWorkoutNameInputField();
      renderPlanSummary();
      setConfigFeedback("success", t("Entrenamiento eliminado.", "Workout deleted."));
      snapshotWorkoutDraft();
      persistWorkouts();
    }

    function updateUI() {
      if (!startPauseBtnEl) return;

      if (sessionTitleEl) {
        sessionTitleEl.textContent = activeWorkout ? activeWorkout.name : t("Sesión", "Session");
      }

      if (workoutPlan.length === 0) {
        timeDisplayEl.textContent = "00:00";
        currentPhaseLabelEl.textContent = t("Sin etapas", "No stages");
        bpmTargetEl.textContent = "-- bpm";
        if (!isRunning) {
          const message = stageDrafts.length === 0
            ? t("Añade etapas para generar el plan.", "Add stages to build the plan.")
            : t("Aplica la configuración para actualizar el plan.", "Apply the configuration to refresh the plan.");
          subStatusEl.textContent = message;
        }
        intervalCountEl.textContent = "";
        progressBarEl.style.width = "0%";
        startPauseBtnEl.textContent = t("Iniciar", "Start");
        startPauseBtnEl.disabled = true;
        skipBtnEl.disabled = true;
        skip10BtnEl.disabled = true;
        return;
      }

      startPauseBtnEl.disabled = false;
      skipBtnEl.disabled = false;
      skip10BtnEl.disabled = false;

      if (currentSegment >= workoutPlan.length) {
        currentSegment = workoutPlan.length - 1;
      }

      const seg = workoutPlan[currentSegment];
      if (!seg) return;

      remaining = Math.max(0, Math.min(remaining, seg.durationSec));
      timeDisplayEl.textContent = fmtTime(remaining);
      currentPhaseLabelEl.textContent = seg.label;
      bpmTargetEl.textContent = seg.bpmLabel;

      if (!isRunning && !started && currentSegment === workoutPlan.length - 1 && remaining === 0) {
        subStatusEl.textContent = t("Sesión terminada", "Session complete");
      } else if (!isRunning && !started && remaining === seg.durationSec) {
        subStatusEl.textContent = t("Pulsa Iniciar", "Press Start");
      } else {
        subStatusEl.textContent = typeHintLabels[seg.type] || "";
      }

      if (seg.repeatIndex != null && seg.repeatTotal != null) {
        intervalCountEl.textContent = t(`Repetición ${seg.repeatIndex} / ${seg.repeatTotal}`, `Repeat ${seg.repeatIndex} / ${seg.repeatTotal}`);
      } else {
        intervalCountEl.textContent = "";
      }

      const elapsedInSeg = seg.durationSec - remaining;
      const pct = seg.durationSec > 0 ? (elapsedInSeg / seg.durationSec) * 100 : 0;
      progressBarEl.style.width = `${pct}%`;

      startPauseBtnEl.textContent = isRunning
        ? t("Pausa", "Pause")
        : (started ? t("Reanudar", "Resume") : t("Iniciar", "Start"));

      updateHrmRangeFeedback();
    }

    function nextSegment() {
      if (workoutPlan.length === 0) return;
      if (currentSegment < workoutPlan.length - 1) {
        currentSegment++;
        remaining = workoutPlan[currentSegment].durationSec;
        playPhaseTransitionSound();
        updateHrmRangeFeedback();
      } else {
        started = false;
        remaining = 0;
        stopTimer();
        subStatusEl.textContent = t("Sesión terminada", "Session complete");
        playPhaseTransitionSound();
        updateHrmRangeFeedback();
      }
    }

    function tick() {
      if (!isRunning || workoutPlan.length === 0) return;
      remaining--;
      if (remaining <= 0) {
        nextSegment();
      }
      updateUI();
      updateHrmRangeFeedback(null);
    }

    function startTimer() {
      if (isRunning || workoutPlan.length === 0) {
        return;
      }
      isRunning = true;
      started = true;
      timerId = setInterval(tick, 1000);
      updateUI();
      requestWakeLock();
    }

    function stopTimer() {
      isRunning = false;
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      updateUI();
      releaseWakeLock();
    }

    function resetTimer() {
      stopTimer();
      currentSegment = 0;
      started = false;
      if (workoutPlan.length > 0) {
        remaining = workoutPlan[0].durationSec;
        subStatusEl.textContent = t("Pulsa Iniciar", "Press Start");
        intervalCountEl.textContent = "";
        progressBarEl.style.width = "0%";
      } else {
        remaining = 0;
        subStatusEl.textContent = t("Configura tus etapas y aplica.", "Configure your stages and apply.");
        intervalCountEl.textContent = "";
        progressBarEl.style.width = "0%";
      }
      updateUI();
    }

    function skipCurrentPhase() {
      if (workoutPlan.length === 0) return;
      nextSegment();
      updateUI();
    }

    function skipSecondsInCurrentPhase(seconds) {
      if (workoutPlan.length === 0) return;
      if (remaining > seconds) {
        remaining -= seconds;
        updateUI();
      } else {
        nextSegment();
        updateUI();
      }
    }

    function ensureAudioContext() {
      const AudioCtor = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtor) return null;
      if (!audioCtx) {
        audioCtx = new AudioCtor();
      }
      if (audioCtx.state === "suspended") {
        audioCtx.resume().catch(function(){
          // ignore resume errors
        });
      }
      return audioCtx;
    }

    function playPhaseTransitionSound() {
      if (!ensureAudioContext() || !audioCtx || audioCtx.state !== "running") return;
      try {
        const now = audioCtx.currentTime;
        const repetitions = 3;
        const gap = 0.55; // seconds between beeps
        const duration = 0.9;

        for (let i = 0; i < repetitions; i++) {
          const startTime = now + i * gap;
          const endTime = startTime + duration;
          const oscillator = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          oscillator.type = "triangle";
          oscillator.frequency.setValueAtTime(1100, startTime);
          oscillator.frequency.exponentialRampToValueAtTime(1700, endTime);
          gain.gain.setValueAtTime(0.001, startTime);
          gain.gain.exponentialRampToValueAtTime(0.4, startTime + 0.06);
          gain.gain.setValueAtTime(0.4, endTime - 0.2);
          gain.gain.exponentialRampToValueAtTime(0.001, endTime);
          oscillator.connect(gain);
          gain.connect(audioCtx.destination);
          oscillator.start(startTime);
          oscillator.stop(endTime + 0.05);
        }
      } catch (err) {
        // ignore playback errors
      }
    }

    async function requestWakeLock() {
      if (!('wakeLock' in navigator)) return;
      if (wakeLockSentinel) return;
      try {
        wakeLockSentinel = await navigator.wakeLock.request('screen');
        wakeLockSentinel.addEventListener('release', function(){
          wakeLockSentinel = null;
          if (isRunning) {
            requestWakeLock();
          }
        });
      } catch (err) {
        wakeLockSentinel = null;
      }
    }

    function releaseWakeLock() {
      if (!wakeLockSentinel) return;
      wakeLockSentinel.release().catch(function(){
        // ignore release errors
      }).finally(function(){
        wakeLockSentinel = null;
      });
    }

    function updateFullscreenButton() {
      if (!document.fullscreenEnabled) {
        fullscreenToggleBtnEl.disabled = true;
      fullscreenToggleBtnEl.textContent = t("Pantalla completa no disponible", "Fullscreen not available");
        return;
      }

      const isFullscreen = document.fullscreenElement != null;
      fullscreenToggleBtnEl.textContent = isFullscreen ? t("Salir de pantalla completa", "Exit fullscreen") : t("Pantalla completa", "Enter fullscreen");
      fullscreenToggleBtnEl.disabled = false;
    }

    function toggleFullscreen() {
      if (!document.fullscreenEnabled) return;

      if (document.fullscreenElement) {
        document.exitFullscreen().catch(function(){
          // ignore errors exiting fullscreen
        });
      } else {
        document.documentElement.requestFullscreen().catch(function(){
          // ignore errors entering fullscreen
        });
      }
    }

    // listeners
    if (configExportBtn) {
      configExportBtn.addEventListener("click", function(){
        exportConfigToJson();
      });
    }

    if (configImportBtn && configImportInput) {
      configImportBtn.addEventListener("click", function(){
        configImportInput.click();
      });
      configImportInput.addEventListener("change", function(event){
        const input = event.target;
        const file = input && input.files ? input.files[0] : null;
        if (file) {
          handleConfigImportFile(file);
        } else {
          configImportInput.value = "";
        }
      });
    }

    if (configAddStageBtn) {
      configAddStageBtn.addEventListener("click", function(){
        stageDrafts.push(createStage({
          name: t("Nueva etapa", "New stage"),
          repeats: 1,
          minutes: 1,
          seconds: 0,
          bpmMin: "",
          bpmMax: "",
          type: "custom"
        }));
        renderStagesForm();
        setConfigFeedback(null, "");
        snapshotWorkoutDraft();
      });
    }

    if (configApplyBtn) {
      configApplyBtn.addEventListener("click", function(){
        applyConfig();
      });
    }

    if (configStagesContainer) {
      configStagesContainer.addEventListener("input", handleStageInput);
      configStagesContainer.addEventListener("change", handleStageInput);
      configStagesContainer.addEventListener("click", handleStageListClick);
    }

    if (workoutSelectEl) {
      workoutSelectEl.addEventListener("change", handleWorkoutSelectChange);
    }

    if (workoutNameInputEl) {
      workoutNameInputEl.addEventListener("input", handleWorkoutNameInput);
      workoutNameInputEl.addEventListener("blur", handleWorkoutNameCommit);
    }

    if (installBtnEl) {
      installBtnEl.addEventListener("click", async function(){
        if (!deferredInstallPrompt) {
          installBtnEl.hidden = true;
          return;
        }
        installBtnEl.disabled = true;
        try {
          deferredInstallPrompt.prompt();
          await deferredInstallPrompt.userChoice;
        } catch (err) {
          console.warn("Install prompt failed", err);
        }
        deferredInstallPrompt = null;
        installBtnEl.disabled = false;
        installBtnEl.hidden = true;
      });
    }

    if (workoutAddBtn) {
      workoutAddBtn.addEventListener("click", handleWorkoutAdd);
    }

    if (workoutDuplicateBtn) {
      workoutDuplicateBtn.addEventListener("click", handleWorkoutDuplicate);
    }

    if (workoutDeleteBtn) {
      workoutDeleteBtn.addEventListener("click", handleWorkoutDelete);
    }

    if (configOpenBtn && configScreenEl) {
      configOpenBtn.addEventListener("click", function(){
        openConfigScreen();
      });
    }

    if (configCloseBtn) {
      configCloseBtn.addEventListener("click", function(){
        closeConfigScreen();
      });
    }

    if (configScreenEl) {
      configScreenEl.addEventListener("click", function(event){
        if (event.target === configScreenEl) {
          closeConfigScreen();
        }
      });
    }

    if (sessionTitleEl) {
      sessionTitleEl.addEventListener("click", function(){
        openSessionPicker();
      });
      sessionTitleEl.addEventListener("keydown", function(event){
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          openSessionPicker();
        }
      });
    }

    if (sessionPickerCloseBtn) {
      sessionPickerCloseBtn.addEventListener("click", function(){
        closeSessionPicker();
      });
    }

    if (sessionPickerEl) {
      sessionPickerEl.addEventListener("click", function(event){
        if (event.target === sessionPickerEl) {
          closeSessionPicker();
        }
      });
    }

    if (sessionPickerListEl) {
      sessionPickerListEl.addEventListener("click", function(event){
        const button = event.target.closest ? event.target.closest(".session-picker-item") : null;
        if (!button) return;
        const workoutId = button.dataset.workoutId;
        if (!workoutId) return;
        const changed = activateWorkout(workoutId);
        if (changed) {
          closeSessionPicker();
        } else {
          closeSessionPicker({ restoreFocus: true });
        }
      });
    }

    document.addEventListener("keydown", function(event){
      if (event.key === "Escape") {
        if (sessionPickerEl && sessionPickerEl.hidden === false) {
          event.preventDefault();
          closeSessionPicker();
          return;
        }
        if (configScreenEl && !configScreenEl.hidden) {
          closeConfigScreen();
        }
      }
    });

    startPauseBtnEl.addEventListener("click", function(){
      ensureAudioContext();
      if (isRunning) {
        stopTimer();
      } else {
        startTimer();
      }
    });

    resetBtnEl.addEventListener("click", function(){
      ensureAudioContext();
      resetTimer();
    });

    skipBtnEl.addEventListener("click", function(){
      ensureAudioContext();
      skipCurrentPhase();
    });

    skip10BtnEl.addEventListener("click", function(){
      ensureAudioContext();
      skipSecondsInCurrentPhase(10);
    });

    fullscreenToggleBtnEl.addEventListener("click", function(){
      toggleFullscreen();
    });

    document.addEventListener("fullscreenchange", updateFullscreenButton);
    document.addEventListener("fullscreenerror", updateFullscreenButton);
    document.addEventListener("visibilitychange", function(){
      if (!document.hidden && isRunning) {
        requestWakeLock();
      }
    });

    window.addEventListener("beforeinstallprompt", function(event){
      event.preventDefault();
      deferredInstallPrompt = event;
      if (installBtnEl) {
        installBtnEl.hidden = false;
      }
    });

    window.addEventListener("appinstalled", function(){
      deferredInstallPrompt = null;
      if (installBtnEl) {
        installBtnEl.hidden = true;
      }
    });

    // --- Monitor de frecuencia cardíaca ---
    const hrmSamples = [];
    const HRM_MAX_POINTS = 120;

    let hrmDevice = null;
    let hrmServer = null;
    let hrmCharacteristic = null;
    let hrmListener = null;
    let hrmCanvas = null;
    let hrmCtx = null;
    let hrmCanvasWidth = 0;
    let hrmCanvasHeight = 0;
    let hrmDrawQueued = false;

    const hrmToggleBtnEl = document.getElementById("hrmToggleBtn");
    const hrmBpmEl = document.getElementById("hrmBpmValue");
    const hrmBpmNumberEl = document.getElementById("hrmBpmNumber");
    const hrmStatusEl = document.getElementById("hrmStatus");
    const hrmRangeStatusEl = document.getElementById("hrmRangeStatus");
    let hrmLastValue = null;

    function hrmSetStatus(message) {
      if (!hrmStatusEl) return;
      hrmStatusEl.textContent = message;
      console.log(message);
    }

    function hrmSetConnectedUI(isConnected) {
      if (!hrmToggleBtnEl) return;
      if (isConnected) {
        hrmToggleBtnEl.textContent = t("Desconectar", "Disconnect");
        hrmToggleBtnEl.classList.remove("disconnected");
        updateHrmRangeFeedback();
      } else {
        hrmToggleBtnEl.textContent = t("Conectar banda", "Connect band");
        hrmToggleBtnEl.classList.add("disconnected");
        if (hrmBpmNumberEl) {
          hrmBpmNumberEl.textContent = "--";
        }
        updateHrmRangeFeedback(null);
      }
    }

    function getCurrentTargetRange() {
      if (!workoutPlan.length) return null;
      const index = Math.min(Math.max(currentSegment, 0), workoutPlan.length - 1);
      const segment = workoutPlan[index];
      if (!segment) return null;
      return {
        min: segment.bpmMin,
        max: segment.bpmMax,
        label: segment.bpmLabel
      };
    }

    function updateHrmRangeFeedback(currentHr) {
      if (typeof currentHr === "undefined") {
        currentHr = hrmLastValue;
      } else if (currentHr === null) {
        hrmLastValue = null;
        currentHr = null;
      } else {
        hrmLastValue = currentHr;
      }

      if (!hrmRangeStatusEl || !hrmBpmEl) return;

      hrmBpmEl.classList.remove("in-range", "low-range", "high-range");
      hrmRangeStatusEl.classList.remove("in-range", "low-range", "high-range");

      const range = getCurrentTargetRange();
      if (!range) {
        hrmRangeStatusEl.textContent = t("Configura tus etapas.", "Configure your stages.");
        return;
      }

      const hasMin = range.min != null && !Number.isNaN(range.min);
      const hasMax = range.max != null && !Number.isNaN(range.max);
      const label = range.label || (hasMin || hasMax ? formatBpmRange(range.min, range.max) : "-- bpm");
      const targetLabel = `${t("Objetivo", "Target")}: ${label}`;

      if (!hasMin && !hasMax) {
        hrmRangeStatusEl.textContent = targetLabel;
        return;
      }

      if (currentHr == null) {
        hrmRangeStatusEl.textContent = targetLabel;
        return;
      }

      let state = "in-range";
      let message = t(`Dentro del objetivo (${label})`, `Within target (${label})`);

      if (hasMin && currentHr < range.min) {
        state = "low-range";
        message = t(`Por debajo del objetivo (${label})`, `Below target (${label})`);
      } else if (hasMax && currentHr > range.max) {
        state = "high-range";
        message = t(`Por encima del objetivo (${label})`, `Above target (${label})`);
      }

      if (state === "in-range") {
        hrmBpmEl.classList.add("in-range");
        hrmRangeStatusEl.classList.add("in-range");
      } else if (state === "low-range") {
        hrmBpmEl.classList.add("low-range");
        hrmRangeStatusEl.classList.add("low-range");
      } else if (state === "high-range") {
        hrmBpmEl.classList.add("high-range");
        hrmRangeStatusEl.classList.add("high-range");
      }

      hrmRangeStatusEl.textContent = message;
    }

    function hrmUpdateBpm(hr) {
      if (hrmBpmNumberEl) {
        hrmBpmNumberEl.textContent = hr.toString();
      }
      hrmSamples.push(hr);
      if (hrmSamples.length > HRM_MAX_POINTS) {
        hrmSamples.shift();
      }
      queueHrmDraw();
      updateHrmRangeFeedback(hr);
    }

    function setupHrmCanvas() {
      hrmCanvas = document.getElementById("hrmChart");
      if (!hrmCanvas) return;
      const dpr = window.devicePixelRatio || 1;
      const rect = hrmCanvas.getBoundingClientRect();
      hrmCanvasWidth = Math.max(rect.width, 1);
      hrmCanvasHeight = Math.max(rect.height, 1);
      hrmCanvas.width = hrmCanvasWidth * dpr;
      hrmCanvas.height = hrmCanvasHeight * dpr;
      hrmCtx = hrmCanvas.getContext("2d");
      if (!hrmCtx) return;
      hrmCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      drawHrmGraph(true);
    }

    function queueHrmDraw(force) {
      if (force) {
        drawHrmGraph(true);
        return;
      }
      if (hrmDrawQueued) return;
      hrmDrawQueued = true;
      requestAnimationFrame(function(){
        hrmDrawQueued = false;
        drawHrmGraph();
      });
    }

    function drawHrmGraph(force) {
      if (!hrmCtx || !hrmCanvasWidth || !hrmCanvasHeight) return;
      hrmCtx.clearRect(0, 0, hrmCanvasWidth, hrmCanvasHeight);
      if (hrmSamples.length === 0) {
        if (force) {
          hrmCtx.strokeStyle = "rgba(148,163,184,0.35)";
          hrmCtx.setLineDash([4, 4]);
          hrmCtx.beginPath();
          hrmCtx.moveTo(0, hrmCanvasHeight / 2);
          hrmCtx.lineTo(hrmCanvasWidth, hrmCanvasHeight / 2);
          hrmCtx.stroke();
          hrmCtx.setLineDash([]);
        }
        return;
      }

      let min = Infinity;
      let max = -Infinity;
      for (const value of hrmSamples) {
        if (value < min) min = value;
        if (value > max) max = value;
      }
      if (min === max) {
        min -= 1;
        max += 1;
      }
      const range = max - min;
      const count = hrmSamples.length;
      const step = count > 1 ? hrmCanvasWidth / (count - 1) : 0;
      const points = [];
      for (let i = 0; i < count; i++) {
        points.push({
          x: step * i,
          y: hrmCanvasHeight - ((hrmSamples[i] - min) / range) * hrmCanvasHeight
        });
      }

      hrmCtx.lineWidth = 2;
      hrmCtx.strokeStyle = "rgba(56,189,248,0.9)";
      hrmCtx.beginPath();
      for (let i = 0; i < points.length; i++) {
        const point = points[i];
        if (i === 0) {
          hrmCtx.moveTo(point.x, point.y);
        } else {
          hrmCtx.lineTo(point.x, point.y);
        }
      }
      hrmCtx.stroke();

      hrmCtx.beginPath();
      hrmCtx.moveTo(points[0].x, hrmCanvasHeight);
      for (const point of points) {
        hrmCtx.lineTo(point.x, point.y);
      }
      hrmCtx.lineTo(points[points.length - 1].x, hrmCanvasHeight);
      hrmCtx.closePath();
      hrmCtx.fillStyle = "rgba(56,189,248,0.15)";
      hrmCtx.fill();
    }

    async function ensureHrmSecureContext() {
      if (location.protocol === "https:" || location.hostname === "localhost" || location.hostname === "127.0.0.1") {
        return true;
      }
      hrmSetStatus(t("Necesitas HTTPS o localhost para usar Web Bluetooth.", "You need HTTPS or localhost to use Web Bluetooth."));
      return false;
    }

    async function hrmHandleDisconnect(message) {
      if (hrmCharacteristic && hrmListener) {
        hrmCharacteristic.removeEventListener("characteristicvaluechanged", hrmListener);
        try {
          await hrmCharacteristic.stopNotifications();
        } catch (err) {
          console.warn("stopNotifications", err);
        }
      }
      if (hrmDevice && hrmDevice.gatt && hrmDevice.gatt.connected) {
        hrmDevice.gatt.disconnect();
      }
      hrmDevice = null;
      hrmServer = null;
      hrmCharacteristic = null;
      hrmListener = null;
      hrmSamples.length = 0;
      queueHrmDraw(true);
      hrmSetConnectedUI(false);
      hrmSetStatus(message || t("Listo para conectar.", "Ready to connect."));
    }

    async function onHrmToggle() {
      if (!navigator.bluetooth) {
        hrmSetStatus(t("navigator.bluetooth no disponible. Usa Chrome.", "navigator.bluetooth not available. Use Chrome."));
        return;
      }

      if (hrmDevice && hrmDevice.gatt && hrmDevice.gatt.connected) {
        await hrmHandleDisconnect(t("Dispositivo desconectado.", "Device disconnected."));
        return;
      }

      if (!(await ensureHrmSecureContext())) {
        return;
      }

      try {
        hrmSetStatus(t("Buscando dispositivo...", "Searching for device..."));
        hrmDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: ["heart_rate"] }]
        });

        hrmDevice.addEventListener("gattserverdisconnected", function(){
          hrmHandleDisconnect(t("Conexión perdida.", "Connection lost."));
        });

        hrmSetStatus(t("Conectando...", "Connecting..."));
        hrmServer = await hrmDevice.gatt.connect();

        const hrService = await hrmServer.getPrimaryService("heart_rate");
        hrmCharacteristic = await hrService.getCharacteristic("heart_rate_measurement");

        hrmListener = function(event) {
          const data = event.target.value;
          const flags = data.getUint8(0);
          const hr = (flags & 1) ? data.getUint16(1, true) : data.getUint8(1);
          hrmUpdateBpm(hr);
          hrmSetStatus(t(`HR recibido: ${hr} bpm`, `HR received: ${hr} bpm`));
        };

        hrmCharacteristic.addEventListener("characteristicvaluechanged", hrmListener);
        await hrmCharacteristic.startNotifications();

        hrmSetConnectedUI(true);
        hrmSetStatus(t("Conectado. Recibiendo datos...", "Connected. Receiving data..."));
      } catch (error) {
        console.error(error);
        await hrmHandleDisconnect(t("Error", "Error") + ": " + error);
      }
    }

    if (hrmToggleBtnEl) {
      hrmToggleBtnEl.addEventListener("click", onHrmToggle);
    }

    window.addEventListener("resize", function(){
      setupHrmCanvas();
      queueHrmDraw(true);
    });

    // init
    bootstrapWorkouts();
    applyStaticTranslations();
    renderStagesForm();
    applyConfig({ silent: true });
    updateFullscreenButton();
    resetTimer();
    hrmSetConnectedUI(false);
    hrmSetStatus(t("Listo para conectar.", "Ready to connect."));
    setupHrmCanvas();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(function(err){
        console.warn('Service worker registration failed', err);
      });
    }
  </script>
</body>
</html>
